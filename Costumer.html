<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trolley — Customer</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#F6F7F9;
      --panel:#FFFFFF;
      --text:#0B0B0C;
      --muted:#6B7280;
      --line:#E5E7EB;

      --accent:#111827;
      --accent2:#0B0B0C;

      --good:#16A34A;
      --warn:#F59E0B;
      --bad:#EF4444;

      --radius:16px;
      --shadow: 0 16px 50px rgba(0,0,0,.10);
      --shadow2: 0 10px 22px rgba(0,0,0,.07);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1100px 700px at 15% 0%, rgba(0,0,0,.06), transparent 60%),
        radial-gradient(1100px 700px at 85% 10%, rgba(0,0,0,.04), transparent 60%),
        var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }
    a{color:inherit;text-decoration:none}
    .hidden{display:none !important;}

    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow2);
    }
    .pad{padding:16px}
    .muted{color:var(--muted)}

    .btn{
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
      user-select:none;
      font-weight:900;
    }
    .btn:hover{border-color:#D1D5DB; box-shadow:0 10px 18px rgba(0,0,0,.06)}
    .btn:active{transform:scale(.99)}
    .btn.primary{
      background:var(--accent);
      color:#fff;
      border-color:transparent;
      box-shadow:0 14px 26px rgba(0,0,0,.18);
    }
    .btn.danger{border-color:rgba(239,68,68,.35); color:#B91C1C}
    .btn.full{width:100%}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      outline:none;
      background:#fff;
      color:var(--text);
    }
    input:focus,select:focus,textarea:focus{
      border-color:rgba(17,24,39,.35);
      box-shadow:0 0 0 4px rgba(17,24,39,.08);
    }
    label{font-size:12px;color:var(--muted)}
    textarea{min-height:90px;resize:vertical}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
      color:var(--muted);
      font-size:12px;
      font-weight:800;
    }
    .badge{
      min-width:22px;height:22px;
      border-radius:999px;
      padding:0 8px;
      display:inline-flex;align-items:center;justify-content:center;
      background:#111827;
      border:1px solid #111827;
      color:#fff;
      font-size:12px;
      font-weight:900;
    }

    /* Toast */
    .toast{position:fixed;right:18px;bottom:18px;width:min(420px,calc(100vw - 36px));display:grid;gap:10px;z-index:999}
    .t{
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      box-shadow:var(--shadow);
      display:flex;gap:10px;align-items:flex-start;
      transition:.35s;
    }
    .dot{width:10px;height:10px;border-radius:999px;margin-top:4px;background:#111827}
    .dot.good{background:var(--good)}
    .dot.bad{background:var(--bad)}
    .dot.warn{background:var(--warn)}
    .t .title{font-weight:900}
    .t .msg{font-size:12px;color:var(--muted);margin-top:2px;white-space:pre-wrap}

    /* AUTH */
    #authView{min-height:100vh;display:grid;place-items:center;padding:18px;}
    .auth-shell{
      width:min(980px,96vw);
      display:grid;
      grid-template-columns: 420px 1fr;
      overflow:hidden;
      border-radius:22px;
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      background:#fff;
    }
    .auth-left{padding:18px;border-right:1px solid var(--line)}
    .auth-right{
      padding:18px;
      background:
        radial-gradient(700px 450px at 20% 10%, rgba(0,0,0,.06), transparent 60%),
        radial-gradient(700px 450px at 85% 10%, rgba(0,0,0,.04), transparent 60%),
        #FBFBFC;
    }
    .logo{
      width:34px;height:34px;border-radius:12px;
      background:linear-gradient(135deg, rgba(0,0,0,.95), rgba(0,0,0,.45));
    }
    .tabs{display:flex;gap:10px;margin-top:14px}
    .tab{
      flex:1;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      cursor:pointer;
      font-weight:900;
    }
    .tab.active{color:var(--text);border-color:rgba(0,0,0,.25);background:rgba(0,0,0,.04)}
    .pane{display:none;gap:10px;margin-top:12px}
    .pane.active{display:grid}
    .alert{
      display:none;margin-top:12px;padding:10px;border-radius:12px;
      border:1px solid rgba(239,68,68,.35);
      background:rgba(239,68,68,.07);
      color:#7F1D1D;white-space:pre-wrap;
    }

    /* APP LAYOUT (Breadfast-ish) */
    #appView{min-height:100vh}
    .shell{max-width:1180px;margin:0 auto;padding:16px}
    .topbar{
      position:sticky;top:0;z-index:20;
      backdrop-filter: blur(10px);
      background:rgba(246,247,249,.82);
      border-bottom:1px solid rgba(229,231,235,.7);
    }
    .topbar-inner{
      max-width:1180px;margin:0 auto;padding:14px 16px;
      display:flex;gap:12px;align-items:center;justify-content:space-between;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .brandName{font-weight:900;letter-spacing:.2px}
    .search{
      flex:1;
      max-width:520px;
      position:relative;
    }
    .search input{padding-left:40px}
    .searchIcon{
      position:absolute;left:12px;top:50%;transform:translateY(-50%);
      width:18px;height:18px;border-radius:6px;
      border:1px solid var(--line);
      display:grid;place-items:center;
      color:var(--muted);
      font-weight:900;
      font-size:12px;
      background:#fff;
    }
    .topActions{display:flex;gap:10px;align-items:center}
    .linkBtn{
      padding:10px 12px;border-radius:12px;border:1px solid transparent;
      color:var(--muted);font-weight:900;cursor:pointer;
      background:transparent;
    }
    .linkBtn.active{color:var(--text);border-color:rgba(0,0,0,.12);background:rgba(0,0,0,.03)}
    .avatar{
      width:36px;height:36px;border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      display:grid;place-items:center;
      font-weight:900;color:var(--muted);
    }

    .hero{
      margin-top:14px;
      display:flex;gap:12px;align-items:stretch;flex-wrap:wrap;
    }
    .hero .card{flex:1;min-width:280px}
    .hero h1{margin:0;font-size:22px;font-weight:900}
    .hero p{margin:8px 0 0 0;line-height:1.6;color:var(--muted)}

    /* Stores grid */
    .sectionHead{display:flex;justify-content:space-between;align-items:end;gap:10px;margin-top:18px}
    .sectionHead h2{margin:0;font-size:16px;font-weight:900}
    .gridStores{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:12px;
    }
    .storeCard{padding:14px;cursor:pointer;transition:.15s}
    .storeCard:hover{transform:translateY(-2px)}
    .storeTop{display:flex;gap:10px;align-items:center}
    .storeLogo{
      width:46px;height:46px;border-radius:16px;
      border:1px solid var(--line);
      background:#F3F4F6;
      overflow:hidden;
      flex:0 0 auto;
      display:grid;place-items:center;
      color:var(--muted);font-weight:900;
    }
    .storeLogo img{width:100%;height:100%;object-fit:cover;display:block}
    .storeName{font-weight:900}
    .storeMeta{font-size:12px;color:var(--muted);margin-top:2px}

    /* Bundles feed */
    .bundleRow{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:12px;
    }
    .bundleCard{padding:14px}
    .bundleImg{
      border:1px solid var(--line);
      border-radius:14px;
      aspect-ratio:16/9;
      background:#F3F4F6;
      overflow:hidden;
    }
    .bundleImg img{width:100%;height:100%;object-fit:cover;display:block}
    .bundleName{font-weight:900;margin-top:10px}
    .bundleDesc{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.5}
    .bundleFoot{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:10px}
    .bundlePrice{font-weight:900}

    /* Store page */
    .crumb{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      margin-top:14px;
    }
    .back{font-weight:900;color:var(--muted);cursor:pointer}
    .back:hover{color:var(--text)}
    .storeHeader{
      margin-top:10px;
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .storeHeaderLeft{display:flex;gap:12px;align-items:center}
    .storeBigLogo{
      width:54px;height:54px;border-radius:18px;
      border:1px solid var(--line);
      background:#F3F4F6;
      overflow:hidden;
      display:grid;place-items:center;
      font-weight:900;color:var(--muted);
    }
    .storeBigLogo img{width:100%;height:100%;object-fit:cover;display:block}
    .cats{
      margin-top:12px;
      display:flex;gap:8px;flex-wrap:wrap;
    }
    .catPill{
      padding:9px 12px;border-radius:999px;border:1px solid var(--line);
      background:#fff;font-weight:900;color:var(--muted);cursor:pointer;
    }
    .catPill.active{color:var(--text);border-color:rgba(0,0,0,.18);background:rgba(0,0,0,.03)}

    .gridProducts{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:12px;
    }
    .pCard{padding:14px;display:flex;flex-direction:column;gap:10px}
    .pImg{
      border:1px solid var(--line);
      border-radius:14px;
      background:#F3F4F6;
      aspect-ratio: 1 / 1;
      overflow:hidden;
    }
    .pImg img{width:100%;height:100%;display:block}
    .pName{font-weight:900}
    .pMeta{font-size:12px;color:var(--muted)}
    .pPrice{font-weight:900}
    .pAdd{margin-top:auto;display:flex;gap:10px;align-items:center;justify-content:space-between}

    /* Drawer cart */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(15,23,42,.45);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease;
      z-index: 50;
    }
    .drawer{
      position:fixed;
      right:18px;
      top:18px;
      width: 440px;
      max-width: calc(100vw - 36px);
      height: calc(100vh - 36px);
      transform: translateX(110%);
      transition: transform .2s ease;
      z-index: 60;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .drawerHead{padding:14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .drawerBody{padding:14px;overflow:auto;display:grid;gap:10px;flex:1}
    .drawerFoot{padding:14px;border-top:1px solid var(--line);display:grid;gap:10px}
    .cartGroup{padding:12px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .cartItem{padding:12px}
    .small{font-size:12px;color:var(--muted)}
    .qtyBtns{display:flex;gap:8px;align-items:center}
    .qtyBtns .btn{padding:8px 10px}

    /* Orders */
    .ordersList{margin-top:12px;display:grid;gap:12px}
    .orderCard{padding:14px}
    .orderItems{margin-top:10px;display:grid;gap:6px}
    .divider{height:1px;background:var(--line);margin:10px 0}

    @media (max-width: 1100px){
      .gridStores{grid-template-columns:repeat(2,minmax(0,1fr))}
      .gridProducts{grid-template-columns:repeat(2,minmax(0,1fr))}
      .bundleRow{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    @media (max-width: 860px){
      .auth-shell{grid-template-columns:1fr}
      .auth-left{border-right:none;border-bottom:1px solid var(--line)}
      .bundleRow{grid-template-columns:1fr}
    }
    @media (max-width: 560px){
      .gridStores{grid-template-columns:1fr}
      .gridProducts{grid-template-columns:1fr}
      .topbar-inner{gap:8px}
      .search{display:none}
    }
  </style>
</head>

<body>
  <div id="toasts" class="toast"></div>

  <!-- AUTH VIEW -->
  <section id="authView">
    <div class="auth-shell">
      <div class="auth-left">
        <div style="display:flex;gap:10px;align-items:center;">
          <div class="logo"></div>
          <div>
            <div style="font-weight:900;">Trolley</div>
            <div class="muted" style="font-size:12px;">Customer</div>
          </div>
        </div>

        <div class="tabs">
          <button class="tab active" data-tab="login">Log in</button>
          <button class="tab" data-tab="signup">Sign up</button>
        </div>

        <div id="paneLogin" class="pane active">
          <label>Email</label>
          <input id="loginEmail" type="email" placeholder="you@email.com" />
          <label>Password</label>
          <input id="loginPass" type="password" placeholder="••••••••" />
          <button id="btnLogin" class="btn primary full">Log in</button>
          <button id="btnForgot" class="btn full">Forgot password</button>
        </div>

        <div id="paneSignup" class="pane">
          <label>Email</label>
          <input id="signupEmail" type="email" placeholder="you@email.com" />
          <label>Password</label>
          <input id="signupPass" type="password" placeholder="Min 6 chars" />
          <button id="btnSignup" class="btn primary full">Create account</button>
          <div class="muted" style="font-size:12px;line-height:1.4;">
            Enable Firebase Authentication → Email/Password.
          </div>
        </div>

        <div id="authAlert" class="alert"></div>
      </div>

      <div class="auth-right">
        <div class="card pad">
          <div class="pill"><span class="badge">New</span> Multi-store cart</div>
          <h2 style="margin:12px 0 6px 0;font-weight:900;">Discover stores & deals</h2>
          <p class="muted" style="margin:0;line-height:1.6;">
            Stores on top. Bundles below. Coupons apply per store only.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- APP VIEW -->
  <section id="appView" class="hidden">
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <div class="logo" style="width:30px;height:30px;border-radius:10px;"></div>
          <div class="brandName">Trolley</div>
        </div>

        <div class="search">
          <div class="searchIcon">⌕</div>
          <input id="globalSearch" placeholder="Search stores, products, bundles..." />
        </div>

        <div class="topActions">
          <button id="navHome" class="linkBtn active">Home</button>
          <button id="navOrders" class="linkBtn">Orders</button>
          <button id="btnCartOpen" class="btn primary">Cart <span id="cartCount" class="badge">0</span></button>
          <div class="avatar" id="userAvatar">U</div>
          <button id="btnSignOut" class="btn">Logout</button>
        </div>
      </div>
    </div>

    <div class="shell">
      <!-- HOME -->
      <section id="viewHome">
        <div class="hero">
          <div class="card pad">
            <h1>Browse stores & shop fast.</h1>
            <p>Choose products from multiple stores. Bundles are shown for attraction. Coupons only discount the store that issued them.</p>
          </div>
          <div class="card pad">
            <div class="pill">Signed in as <b id="userEmail">—</b></div>
            <div style="margin-top:12px" class="hint muted">Tip: click a store to enter it.</div>
          </div>
        </div>

        <div class="sectionHead">
          <div>
            <h2>Stores</h2>
            <div class="muted" style="font-size:12px;margin-top:4px;">Tap a store to open its products.</div>
          </div>
          <button class="btn" id="btnReloadHome">Reload</button>
        </div>

        <div class="gridStores" id="storesGrid">
          <div class="card pad muted">Loading stores…</div>
        </div>

        <div class="sectionHead">
          <div>
            <h2>Bundles (All Stores)</h2>
            <div class="muted" style="font-size:12px;margin-top:4px;">Deals across all stores. Each shows its store name.</div>
          </div>
        </div>

        <div class="bundleRow" id="bundlesGrid">
          <div class="card pad muted">Loading bundles…</div>
        </div>
      </section>

      <!-- STORE -->
      <section id="viewStore" class="hidden">
        <div class="crumb">
          <span class="back" id="btnBackHome">← Back</span>
          <span class="pill">Store</span>
        </div>

        <div class="storeHeader">
          <div class="storeHeaderLeft">
            <div class="storeBigLogo" id="storeBigLogo">S</div>
            <div>
              <div style="font-weight:900;font-size:18px" id="storeName">—</div>
              <div class="muted" style="font-size:12px" id="storeSub">Loading…</div>
            </div>
          </div>
          <div class="row">
            <div class="pill">Store-only coupons apply inside cart</div>
          </div>
        </div>

        <div class="cats" id="catsBar"></div>
        <div class="gridProducts" id="productsGrid"></div>

        <div class="sectionHead">
          <div>
            <h2>Bundles from this store</h2>
            <div class="muted" style="font-size:12px;margin-top:4px;">These are store deals.</div>
          </div>
        </div>
        <div class="bundleRow" id="storeBundlesGrid"></div>
      </section>

      <!-- ORDERS -->
      <section id="viewOrders" class="hidden">
        <div class="sectionHead">
          <div>
            <h2>Your Orders</h2>
            <div class="muted" style="font-size:12px;margin-top:4px;">Past orders + Order Again.</div>
          </div>
          <button id="btnReloadOrders" class="btn">Reload</button>
        </div>

        <div class="ordersList" id="ordersList">
          <div class="card pad muted">Loading orders…</div>
        </div>
      </section>
    </div>

    <!-- CART DRAWER -->
    <div id="backdrop" class="backdrop"></div>
    <aside id="drawer" class="drawer card">
      <div class="drawerHead">
        <div>
          <div style="font-weight:900;">Cart</div>
          <div class="muted" style="font-size:12px;">Multi-store cart. Coupons apply per store only.</div>
        </div>
        <button id="btnCartClose" class="btn">Close</button>
      </div>

      <div id="cartBody" class="drawerBody">
        <div class="muted">Your cart is empty.</div>
      </div>

      <div class="drawerFoot">
        <div class="row">
          <div class="muted">Subtotal</div>
          <div style="font-weight:900;" id="subtotal">$0.00</div>
        </div>
        <div class="row">
          <div class="muted">Discount</div>
          <div style="font-weight:900;" id="discount">$0.00</div>
        </div>
        <div class="row">
          <div style="font-weight:900;">Total</div>
          <div style="font-weight:900;" id="total">$0.00</div>
        </div>

        <div class="divider"></div>

        <label>Delivery note (optional)</label>
        <textarea id="note" placeholder="e.g., call on arrival"></textarea>

        <button id="btnCheckout" class="btn primary full">Place Order</button>
        <button id="btnClearCart" class="btn danger full">Clear Cart</button>

        <div id="shopAlert" class="alert"></div>
      </div>
    </aside>
  </section>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    sendPasswordResetEmail,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getDatabase, ref, get, push, update } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCDQod1xzLOqAFgRDN50ohwLGWBtBwFVLc",
    authDomain: "trolley-89d31.firebaseapp.com",
    databaseURL: "https://trolley-89d31-default-rtdb.firebaseio.com",
    projectId: "trolley-89d31",
    storageBucket: "trolley-89d31.firebasestorage.app",
    messagingSenderId: "129434473018",
    appId: "1:129434473018:web:ae6b35d2d55526a7cedb03",
    measurementId: "G-81TRQL41K5"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));
  const money = (n)=>`$${Number(n||0).toFixed(2)}`;

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function toast(type, title, msg){
    const wrap = $("#toasts");
    const el = document.createElement("div");
    el.className = "t";
    const dot = type==="good"?"good":type==="bad"?"bad":"warn";
    el.innerHTML = `
      <div class="dot ${dot}"></div>
      <div>
        <div class="title">${escapeHtml(title)}</div>
        <div class="msg">${escapeHtml(msg||"")}</div>
      </div>
    `;
    wrap.appendChild(el);
    setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(8px)"; }, 3400);
    setTimeout(()=>{ el.remove(); }, 4000);
  }

  function showAuthAlert(m){
    const a = $("#authAlert");
    a.style.display="block";
    a.textContent = m;
  }
  function clearAuthAlert(){
    const a = $("#authAlert");
    a.style.display="none";
    a.textContent = "";
  }
  function showShopAlert(m){
    const a = $("#shopAlert");
    a.style.display="block";
    a.textContent = m;
  }
  function clearShopAlert(){
    const a = $("#shopAlert");
    a.style.display="none";
    a.textContent = "";
  }

  function setAppVisible(isLoggedIn){
    $("#authView").classList.toggle("hidden", isLoggedIn);
    $("#appView").classList.toggle("hidden", !isLoggedIn);
    document.body.style.overflowY = isLoggedIn ? "auto" : "hidden";
  }

  // AUTH tabs
  $$(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      $$(".tab").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const which = btn.dataset.tab;
      $("#paneLogin").classList.toggle("active", which==="login");
      $("#paneSignup").classList.toggle("active", which==="signup");
      clearAuthAlert();
    });
  });

  $("#btnLogin").addEventListener("click", async ()=>{
    clearAuthAlert();
    const email = $("#loginEmail").value.trim();
    const pass  = $("#loginPass").value;
    if(!email || !pass) return showAuthAlert("Enter email and password.");
    try{ await signInWithEmailAndPassword(auth, email, pass); }
    catch(e){ showAuthAlert(e.message); }
  });

  $("#btnSignup").addEventListener("click", async ()=>{
    clearAuthAlert();
    const email = $("#signupEmail").value.trim();
    const pass  = $("#signupPass").value;
    if(!email || !pass) return showAuthAlert("Enter email and password.");
    if(pass.length < 6) return showAuthAlert("Password must be at least 6 characters.");
    try{ await createUserWithEmailAndPassword(auth, email, pass); }
    catch(e){ showAuthAlert(e.message); }
  });

  $("#btnForgot").addEventListener("click", async ()=>{
    clearAuthAlert();
    const email = $("#loginEmail").value.trim();
    if(!email) return showAuthAlert("Type your email in the login field first.");
    try{ await sendPasswordResetEmail(auth, email); showAuthAlert("Password reset email sent."); }
    catch(e){ showAuthAlert(e.message); }
  });

  $("#btnSignOut").addEventListener("click", async ()=>{ await signOut(auth); });

  // NAV (home/orders) + view switching
  function showView(name){
    $("#viewHome").classList.toggle("hidden", name !== "home");
    $("#viewStore").classList.toggle("hidden", name !== "store");
    $("#viewOrders").classList.toggle("hidden", name !== "orders");

    $("#navHome").classList.toggle("active", name==="home" || name==="store");
    $("#navOrders").classList.toggle("active", name==="orders");
  }

  $("#navHome").addEventListener("click", ()=> { location.hash = "#home"; });
  $("#navOrders").addEventListener("click", ()=> { location.hash = "#orders"; });

  $("#btnBackHome").addEventListener("click", ()=> { location.hash = "#home"; });

  function parseHash(){
    const h = location.hash || "#home";
    if(h.startsWith("#store:")){
      return { view:"store", storeId: h.slice("#store:".length) };
    }
    if(h === "#orders") return { view:"orders" };
    return { view:"home" };
  }
  window.addEventListener("hashchange", ()=> route());
  function route(){
    const r = parseHash();
    if(r.view === "home"){ showView("home"); }
    if(r.view === "orders"){ showView("orders"); }
    if(r.view === "store"){ showView("store"); }
    if(r.view === "store"){ openStore(r.storeId); }
    if(r.view === "orders"){ loadOrders(); }
  }

  // ========= DATA =========
  const state = {
    user: null,

    stores: [], // { storeId, name, logoUrl }
    storesById: {},

    productsByStore: {}, // storeId -> { prodId: {...} }
    bundlesByStore: {},  // storeId -> { bundleId: {...} }
    couponsByStore: {},  // storeId -> { couponId: {...} }

    // cart key = `${storeId}::${prodId}`
    cart: new Map(), // key -> { storeId, prodId, name, price, qty, imageUrl, imageFit, imagePosX, imagePosY }
    appliedCoupons: {}, // storeId -> { code, type, value, valid, reason }

    orders: [] // customerOrders
  };

  // ========= HOME LOADERS =========
  async function loadHome(){
    $("#storesGrid").innerHTML = `<div class="card pad muted">Loading stores…</div>`;
    $("#bundlesGrid").innerHTML = `<div class="card pad muted">Loading bundles…</div>`;

    // Read all stores (small MVP assumption)
    const snap = await get(ref(db, "stores"));
    const stores = [];
    const bundles = [];

    if(snap.exists()){
      const all = snap.val() || {};
      for(const [storeId, storeObj] of Object.entries(all)){
        const meta = storeObj?.meta || {};
        const name = meta.name || `Store ${storeId.slice(0,6)}`;
        const logoUrl = meta.logoUrl || "";
        stores.push({ storeId, name, logoUrl });

        // collect bundles for home feed
        const b = storeObj?.bundles || {};
        for(const [bundleId, bundle] of Object.entries(b)){
          if(bundle?.active === false) continue;
          bundles.push({
            storeId, storeName: name,
            bundleId,
            name: bundle?.name || "Bundle",
            desc: bundle?.desc || "",
            price: Number(bundle?.price || 0),
            imageUrl: bundle?.imageUrl || ""
          });
        }
      }
    }

    stores.sort((a,b)=>a.name.localeCompare(b.name));
    // show newest-ish bundles first
    bundles.sort((a,b)=> (b.price - a.price));

    state.stores = stores;
    state.storesById = Object.fromEntries(stores.map(s=>[s.storeId, s]));

    renderStoresGrid();
    renderBundlesFeed(bundles);
  }

  function renderStoresGrid(){
    const q = ($("#globalSearch").value || "").trim().toLowerCase();
    const list = state.stores.filter(s=>{
      if(!q) return true;
      return s.name.toLowerCase().includes(q);
    });

    const el = $("#storesGrid");
    if(list.length === 0){
      el.innerHTML = `<div class="card pad muted">No stores found.</div>`;
      return;
    }

    el.innerHTML = list.map(s=>{
      const logo = s.logoUrl
        ? `<img src="${escapeHtml(s.logoUrl)}" alt="logo">`
        : `<span>${escapeHtml((s.name||"S").slice(0,1).toUpperCase())}</span>`;
      return `
        <div class="card storeCard" data-open-store="${escapeHtml(s.storeId)}">
          <div class="storeTop">
            <div class="storeLogo">${logo}</div>
            <div style="min-width:0">
              <div class="storeName">${escapeHtml(s.name)}</div>
              <div class="storeMeta">Tap to open</div>
            </div>
          </div>
        </div>
      `;
    }).join("");

    el.querySelectorAll("[data-open-store]").forEach(card=>{
      card.addEventListener("click", ()=>{
        const storeId = card.dataset.openStore;
        location.hash = `#store:${storeId}`;
      });
    });
  }

  function renderBundlesFeed(bundles){
    const q = ($("#globalSearch").value || "").trim().toLowerCase();

    const filtered = bundles.filter(b=>{
      if(!q) return true;
      return (b.name||"").toLowerCase().includes(q)
          || (b.desc||"").toLowerCase().includes(q)
          || (b.storeName||"").toLowerCase().includes(q);
    });

    const el = $("#bundlesGrid");
    if(filtered.length === 0){
      el.innerHTML = `<div class="card pad muted">No bundles found.</div>`;
      return;
    }

    el.innerHTML = filtered.slice(0, 12).map(b=>{
      const img = b.imageUrl
        ? `<img src="${escapeHtml(b.imageUrl)}" alt="bundle">`
        : ``;
      return `
        <div class="card bundleCard">
          <div class="bundleImg">${img}</div>
          <div class="bundleName">${escapeHtml(b.name)}</div>
          <div class="bundleDesc">${escapeHtml(b.desc || "—")}</div>
          <div class="bundleDesc"><b>${escapeHtml(b.storeName)}</b></div>
          <div class="bundleFoot">
            <div class="bundlePrice">${money(b.price)}</div>
            <button class="btn" data-open-store="${escapeHtml(b.storeId)}">Open store</button>
          </div>
        </div>
      `;
    }).join("");

    el.querySelectorAll("[data-open-store]").forEach(btn=>{
      btn.addEventListener("click", ()=> location.hash = `#store:${btn.dataset.openStore}`);
    });
  }

  $("#btnReloadHome").addEventListener("click", ()=> loadHome());
  $("#globalSearch").addEventListener("input", ()=> {
    renderStoresGrid();
    // bundles feed is rebuilt by reload; quick approach: reload home bundles from cached stores would require caching. We'll just reload once when typing stops.
  });

  // ========= STORE PAGE =========
  let currentStoreId = null;
  let currentCat = "All";

  async function openStore(storeId){
    currentStoreId = storeId;
    currentCat = "All";

    const store = state.storesById[storeId];
    $("#storeName").textContent = store?.name || "Store";
    $("#storeSub").textContent  = `Store ID: ${storeId}`;
    $("#storeBigLogo").innerHTML = store?.logoUrl
      ? `<img src="${escapeHtml(store.logoUrl)}" alt="logo">`
      : `<span>${escapeHtml((store?.name||"S").slice(0,1).toUpperCase())}</span>`;

    $("#productsGrid").innerHTML = `<div class="card pad muted" style="grid-column:1/-1;">Loading products…</div>`;
    $("#storeBundlesGrid").innerHTML = `<div class="card pad muted" style="grid-column:1/-1;">Loading bundles…</div>`;

    // Load products/bundles/coupons for store
    const snap = await get(ref(db, `stores/${storeId}`));
    const obj = snap.exists() ? (snap.val() || {}) : {};
    const products = obj.products || {};
    const bundles  = obj.bundles  || {};
    const coupons  = obj.coupons  || {};

    state.productsByStore[storeId] = products;
    state.bundlesByStore[storeId]  = bundles;
    state.couponsByStore[storeId]  = coupons;

    renderCatsBar(storeId);
    renderStoreProducts(storeId);
    renderStoreBundles(storeId);
  }

  function renderCatsBar(storeId){
    const products = state.productsByStore[storeId] || {};
    const cats = new Set(["All"]);
    for(const p of Object.values(products)){
      if(p?.active === false) continue;
      if(p?.category) cats.add(p.category);
    }
    const list = Array.from(cats).sort((a,b)=> a==="All" ? -1 : b==="All" ? 1 : a.localeCompare(b));

    const el = $("#catsBar");
    el.innerHTML = list.map(c=>`
      <div class="catPill ${c===currentCat ? "active":""}" data-cat="${escapeHtml(c)}">${escapeHtml(c)}</div>
    `).join("");

    el.querySelectorAll("[data-cat]").forEach(p=>{
      p.addEventListener("click", ()=>{
        currentCat = p.dataset.cat;
        renderCatsBar(storeId);
        renderStoreProducts(storeId);
      });
    });
  }

  function applyImageStyle(img, p){
    const fit = p?.imageFit || "cover";
    const x = Number(p?.imagePosX ?? 50);
    const y = Number(p?.imagePosY ?? 50);
    img.style.objectFit = fit;
    img.style.objectPosition = `${x}% ${y}%`;
  }

  function renderStoreProducts(storeId){
    const products = state.productsByStore[storeId] || {};
    const q = ($("#globalSearch").value || "").trim().toLowerCase();

    const list = Object.entries(products)
      .map(([prodId, p])=>({ prodId, ...p }))
      .filter(p=>{
        if(p.active === false) return false;
        if(currentCat !== "All" && p.category !== currentCat) return false;
        if(q){
          return String(p.name||"").toLowerCase().includes(q)
              || String(p.category||"").toLowerCase().includes(q);
        }
        return true;
      })
      .sort((a,b)=> (a.name||"").localeCompare(b.name||""));

    const el = $("#productsGrid");
    if(list.length === 0){
      el.innerHTML = `<div class="card pad muted" style="grid-column:1/-1;">No products found.</div>`;
      return;
    }

    el.innerHTML = list.map(p=>{
      const img = p.imageUrl
        ? `<img data-img="${escapeHtml(p.prodId)}" src="${escapeHtml(p.imageUrl)}" alt="product">`
        : ``;
      return `
        <div class="card pCard">
          <div class="pImg">${img}</div>
          <div>
            <div class="pName">${escapeHtml(p.name || "Product")}</div>
            <div class="pMeta">${escapeHtml(p.category || "")}</div>
          </div>
          <div class="pAdd">
            <div class="pPrice">${money(Number(p.price||0))}</div>
            <button class="btn primary" data-add="${escapeHtml(p.prodId)}">Add</button>
          </div>
        </div>
      `;
    }).join("");

    // apply object-fit/position for saved image controls
    el.querySelectorAll("[data-img]").forEach(imgEl=>{
      const prodId = imgEl.dataset.img;
      const p = products[prodId] || {};
      applyImageStyle(imgEl, p);
    });

    el.querySelectorAll("[data-add]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const prodId = btn.dataset.add;
        addToCart(storeId, prodId, 1);
      });
    });
  }

  function renderStoreBundles(storeId){
    const bundles = state.bundlesByStore[storeId] || {};
    const storeName = state.storesById[storeId]?.name || "Store";
    const list = Object.entries(bundles)
      .map(([bundleId,b])=>({ bundleId, ...b }))
      .filter(b=> b.active !== false)
      .sort((a,b)=> (a.name||"").localeCompare(b.name||""));

    const el = $("#storeBundlesGrid");
    if(list.length === 0){
      el.innerHTML = `<div class="card pad muted" style="grid-column:1/-1;">No bundles here.</div>`;
      return;
    }

    el.innerHTML = list.map(b=>{
      const img = b.imageUrl ? `<img src="${escapeHtml(b.imageUrl)}" alt="bundle">` : ``;
      return `
        <div class="card bundleCard">
          <div class="bundleImg">${img}</div>
          <div class="bundleName">${escapeHtml(b.name || "Bundle")}</div>
          <div class="bundleDesc">${escapeHtml(b.desc || "—")}</div>
          <div class="bundleDesc"><b>${escapeHtml(storeName)}</b></div>
          <div class="bundleFoot">
            <div class="bundlePrice">${money(Number(b.price||0))}</div>
            <button class="btn" data-add-bundle="${escapeHtml(b.bundleId)}">Add bundle items</button>
          </div>
        </div>
      `;
    }).join("");

    el.querySelectorAll("[data-add-bundle]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const bundleId = btn.dataset.addBundle;
        const b = bundles[bundleId];
        if(!b?.items) return toast("warn","Bundle","Bundle has no items.");
        // Add each product in bundle to cart
        for(const [prodId, qty] of Object.entries(b.items)){
          addToCart(storeId, prodId, Number(qty||0));
        }
        toast("good","Added", "Bundle items added to cart.");
      });
    });
  }

  // ========= CART (multi-store + store-specific coupons) =========
  const backdrop = $("#backdrop");
  const drawer = $("#drawer");

  function openDrawer(){
    drawer.style.transform = "translateX(0)";
    backdrop.style.opacity = "1";
    backdrop.style.pointerEvents = "auto";
  }
  function closeDrawer(){
    drawer.style.transform = "translateX(110%)";
    backdrop.style.opacity = "0";
    backdrop.style.pointerEvents = "none";
  }
  $("#btnCartOpen").addEventListener("click", ()=>{ renderCart(); openDrawer(); });
  $("#btnCartClose").addEventListener("click", closeDrawer);
  backdrop.addEventListener("click", closeDrawer);

  function cartKey(storeId, prodId){ return `${storeId}::${prodId}`; }

  function addToCart(storeId, prodId, qty){
    clearShopAlert();
    qty = Number(qty||0);
    if(qty <= 0) return;

    const products = state.productsByStore[storeId] || {};
    const p = products[prodId];
    if(!p){ toast("bad","Missing product","Open store again and try."); return; }

    const key = cartKey(storeId, prodId);
    const it = state.cart.get(key);
    if(it) it.qty += qty;
    else {
      state.cart.set(key, {
        storeId, prodId,
        name: p.name || "Product",
        price: Number(p.price||0),
        qty,
        imageUrl: p.imageUrl || "",
        imageFit: p.imageFit || "cover",
        imagePosX: Number(p.imagePosX ?? 50),
        imagePosY: Number(p.imagePosY ?? 50)
      });
    }
    renderCart();
    toast("good","Added", "Item added to cart.");
  }

  function decCart(storeId, prodId, qty){
    qty = Number(qty||0);
    if(qty<=0) return;
    const key = cartKey(storeId, prodId);
    const it = state.cart.get(key);
    if(!it) return;
    it.qty -= qty;
    if(it.qty <= 0) state.cart.delete(key);
    renderCart();
  }

  function removeCart(storeId, prodId){
    state.cart.delete(cartKey(storeId, prodId));
    renderCart();
  }

  function clearCart(){
    state.cart.clear();
    state.appliedCoupons = {};
    renderCart();
  }
  $("#btnClearCart").addEventListener("click", clearCart);

  function groupCartByStore(){
    const groups = {};
    for(const it of state.cart.values()){
      if(!groups[it.storeId]) groups[it.storeId] = [];
      groups[it.storeId].push(it);
    }
    return groups;
  }

  function computeStoreSubtotal(items){
    return items.reduce((s,it)=> s + (it.price * it.qty), 0);
  }

  function computeDiscountForStore(storeId, subtotal){
    const ac = state.appliedCoupons[storeId];
    if(!ac || !ac.valid) return 0;
    if(ac.type === "percent"){
      return subtotal * (Number(ac.value||0) / 100);
    }
    if(ac.type === "fixed"){
      return Math.min(subtotal, Number(ac.value||0));
    }
    return 0;
  }

  async function validateCoupon(storeId, code){
    code = String(code||"").trim().toUpperCase();
    if(!code) return { valid:false, reason:"Enter a code." };

    // Ensure coupons loaded
    if(!state.couponsByStore[storeId]){
      const snap = await get(ref(db, `stores/${storeId}/coupons`));
      state.couponsByStore[storeId] = snap.exists() ? (snap.val()||{}) : {};
    }

    const coupons = state.couponsByStore[storeId] || {};
    const now = new Date().toISOString().slice(0,10);

    for(const c of Object.values(coupons)){
      if(c?.active === false) continue;
      if(String(c?.code||"").toUpperCase() !== code) continue;

      // optional date window
      const start = c.start || "";
      const end = c.end || "";
      if(start && now < start) return { valid:false, reason:"Coupon not active yet." };
      if(end && now > end) return { valid:false, reason:"Coupon expired." };

      return { valid:true, type:c.type || "percent", value:Number(c.value||0), reason:"Applied" };
    }
    return { valid:false, reason:"Invalid code for this store." };
  }

  function renderCart(){
    const cartBody = $("#cartBody");
    const cartCount = $("#cartCount");
    const subtotalEl = $("#subtotal");
    const discountEl = $("#discount");
    const totalEl = $("#total");

    const groups = groupCartByStore();
    const storeIds = Object.keys(groups);

    let count = 0;
    for(const it of state.cart.values()) count += it.qty;
    cartCount.textContent = String(count);

    if(storeIds.length === 0){
      cartBody.innerHTML = `<div class="muted">Your cart is empty.</div>`;
      subtotalEl.textContent = money(0);
      discountEl.textContent = money(0);
      totalEl.textContent = money(0);
      return;
    }

    let grandSubtotal = 0;
    let grandDiscount = 0;

    cartBody.innerHTML = storeIds.map(storeId=>{
      const items = groups[storeId];
      const storeName = state.storesById[storeId]?.name || storeId;
      const sub = computeStoreSubtotal(items);
      const disc = computeDiscountForStore(storeId, sub);

      grandSubtotal += sub;
      grandDiscount += disc;

      const applied = state.appliedCoupons[storeId];
      const appliedText = applied
        ? (applied.valid ? `Applied: ${applied.code}` : `Invalid: ${applied.code}`)
        : `No coupon`;

      return `
        <div class="card cartGroup">
          <div class="row">
            <div style="font-weight:900;">${escapeHtml(storeName)}</div>
            <div class="pill">${appliedText}</div>
          </div>

          <div class="divider"></div>

          ${items.map(it=>{
            const line = it.price * it.qty;
            const img = it.imageUrl
              ? `<img data-cimg="${escapeHtml(storeId)}::${escapeHtml(it.prodId)}" src="${escapeHtml(it.imageUrl)}" alt="item">`
              : ``;
            return `
              <div class="card cartItem">
                <div class="row">
                  <div style="display:flex;gap:10px;align-items:center;">
                    <div class="pImg" style="width:56px;height:56px;border-radius:14px;margin:0;flex:0 0 auto;">${img}</div>
                    <div>
                      <div style="font-weight:900;">${escapeHtml(it.name)}</div>
                      <div class="small">${money(it.price)} • qty ${it.qty}</div>
                    </div>
                  </div>
                  <div style="font-weight:900;">${money(line)}</div>
                </div>

                <div class="row" style="margin-top:10px;">
                  <div class="qtyBtns">
                    <button class="btn" data-dec="${escapeHtml(storeId)}" data-prod="${escapeHtml(it.prodId)}">−</button>
                    <button class="btn" data-inc="${escapeHtml(storeId)}" data-prod="${escapeHtml(it.prodId)}">+</button>
                    <button class="btn danger" data-rm="${escapeHtml(storeId)}" data-prod="${escapeHtml(it.prodId)}">Remove</button>
                  </div>
                </div>
              </div>
            `;
          }).join("")}

          <div class="divider"></div>

          <div class="row">
            <div class="small">Store subtotal</div>
            <div style="font-weight:900;">${money(sub)}</div>
          </div>
          <div class="row">
            <div class="small">Store discount</div>
            <div style="font-weight:900;">-${money(disc)}</div>
          </div>

          <div class="divider"></div>

          <label>Coupon for ${escapeHtml(storeName)} (store-only)</label>
          <div class="row" style="align-items:stretch;">
            <input data-coupon-input="${escapeHtml(storeId)}" placeholder="e.g., SAVE10" />
            <button class="btn" data-apply-coupon="${escapeHtml(storeId)}">Apply</button>
            <button class="btn" data-clear-coupon="${escapeHtml(storeId)}">Clear</button>
          </div>
          <div class="small" data-coupon-msg="${escapeHtml(storeId)}"></div>
        </div>
      `;
    }).join("");

    // Apply image fit/position for cart thumbnails
    cartBody.querySelectorAll("[data-cimg]").forEach(img=>{
      const [sid, pid] = img.dataset.cimg.split("::");
      const key = cartKey(sid, pid);
      const it = state.cart.get(key);
      if(!it) return;
      img.style.objectFit = it.imageFit || "cover";
      img.style.objectPosition = `${Number(it.imagePosX ?? 50)}% ${Number(it.imagePosY ?? 50)}%`;
    });

    // Qty buttons
    cartBody.querySelectorAll("[data-inc]").forEach(b=>{
      b.addEventListener("click", ()=> addToCart(b.dataset.inc, b.dataset.prod, 1));
    });
    cartBody.querySelectorAll("[data-dec]").forEach(b=>{
      b.addEventListener("click", ()=> decCart(b.dataset.dec, b.dataset.prod, 1));
    });
    cartBody.querySelectorAll("[data-rm]").forEach(b=>{
      b.addEventListener("click", ()=> removeCart(b.dataset.rm, b.dataset.prod));
    });

    // Coupon handlers (per store)
    cartBody.querySelectorAll("[data-apply-coupon]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        clearShopAlert();
        const storeId = btn.dataset.applyCoupon;
        const input = cartBody.querySelector(`[data-coupon-input="${storeId}"]`);
        const msg = cartBody.querySelector(`[data-coupon-msg="${storeId}"]`);
        const code = (input?.value || "").trim().toUpperCase();
        msg.textContent = "Checking…";

        try{
          const res = await validateCoupon(storeId, code);
          state.appliedCoupons[storeId] = { code, ...res };
          msg.textContent = res.valid ? "Applied ✅" : `Not valid: ${res.reason}`;
          renderCart();
        }catch(e){
          msg.textContent = "Error checking coupon.";
          toast("bad","Coupon error", e.message || String(e));
        }
      });
    });

    cartBody.querySelectorAll("[data-clear-coupon]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const storeId = btn.dataset.clearCoupon;
        delete state.appliedCoupons[storeId];
        renderCart();
      });
    });

    // Totals
    const grandTotal = Math.max(0, grandSubtotal - grandDiscount);
    subtotalEl.textContent = money(grandSubtotal);
    discountEl.textContent = money(grandDiscount);
    totalEl.textContent = money(grandTotal);
  }

  // ========= CHECKOUT + ORDERS =========
  async function loadOrders(){
    if(!state.user) return;

    $("#ordersList").innerHTML = `<div class="card pad muted">Loading orders…</div>`;

    const snap = await get(ref(db, `customerOrders/${state.user.uid}`));
    const all = snap.exists() ? (snap.val() || {}) : {};
    const orders = Object.entries(all).map(([id,o])=>({ id, ...o }))
      .sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));

    state.orders = orders;
    renderOrders();
  }

  function renderOrders(){
    const el = $("#ordersList");
    if(state.orders.length === 0){
      el.innerHTML = `<div class="card pad muted">No orders yet.</div>`;
      return;
    }

    el.innerHTML = state.orders.map(o=>{
      const dt = new Date(o.createdAt || Date.now()).toLocaleString();
      const stores = Object.keys(o.storeBreakdown || {});
      return `
        <div class="card orderCard">
          <div class="row">
            <div>
              <div style="font-weight:900;">Order #${escapeHtml(o.orderNumber || o.id)}</div>
              <div class="small">${escapeHtml(dt)}</div>
            </div>
            <div style="font-weight:900;">${money(o.total)}</div>
          </div>

          <div class="divider"></div>

          <div class="small">Stores: ${escapeHtml(stores.map(sid=> state.storesById[sid]?.name || sid).join(", "))}</div>

          <div class="orderItems">
            ${(o.items || []).slice(0,8).map(it=>`
              <div class="row small">
                <div>${escapeHtml(it.name)} <span class="muted">× ${it.qty}</span></div>
                <div>${money(it.price * it.qty)}</div>
              </div>
            `).join("")}
          </div>

          <div class="divider"></div>

          <div class="row" style="justify-content:flex-end;gap:10px;">
            <button class="btn" data-order-again="${escapeHtml(o.id)}">Order again</button>
          </div>
        </div>
      `;
    }).join("");

    el.querySelectorAll("[data-order-again]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.dataset.orderAgain;
        const order = state.orders.find(x=>x.id===id);
        if(!order) return;
        orderAgain(order);
      });
    });
  }

  function orderAgain(order){
    if(!order?.items?.length) return toast("warn","Order again","Order has no items.");

    // Add to cart exactly as last order (multi-store)
    for(const it of order.items){
      // We'll add directly to cart (doesn't depend on current store page)
      const key = cartKey(it.storeId, it.prodId);
      const existing = state.cart.get(key);
      if(existing) existing.qty += Number(it.qty||0);
      else {
        state.cart.set(key, {
          storeId: it.storeId,
          prodId: it.prodId,
          name: it.name,
          price: Number(it.price||0),
          qty: Number(it.qty||0),
          imageUrl: it.imageUrl || "",
          imageFit: it.imageFit || "cover",
          imagePosX: Number(it.imagePosX ?? 50),
          imagePosY: Number(it.imagePosY ?? 50)
        });
      }
    }

    toast("good","Added","Items added to cart.");
    renderCart();
    openDrawer();
  }

  $("#btnReloadOrders").addEventListener("click", ()=> loadOrders());

  $("#btnCheckout").addEventListener("click", async ()=>{
    clearShopAlert();
    if(!state.user) return showShopAlert("Not logged in.");
    if(state.cart.size === 0) return showShopAlert("Cart is empty.");

    try{
      const groups = groupCartByStore();
      const storeIds = Object.keys(groups);

      // Build flat items list
      const items = [];
      const storeBreakdown = {};
      let grandSubtotal = 0;
      let grandDiscount = 0;

      for(const storeId of storeIds){
        const list = groups[storeId];
        const sub = computeStoreSubtotal(list);
        const disc = computeDiscountForStore(storeId, sub);

        grandSubtotal += sub;
        grandDiscount += disc;

        storeBreakdown[storeId] = {
          storeName: state.storesById[storeId]?.name || storeId,
          subtotal: sub,
          discount: disc,
          coupon: state.appliedCoupons[storeId]?.valid ? state.appliedCoupons[storeId] : null
        };

        for(const it of list){
          items.push({
            storeId: it.storeId,
            prodId: it.prodId,
            name: it.name,
            price: it.price,
            qty: it.qty,
            imageUrl: it.imageUrl || "",
            imageFit: it.imageFit || "cover",
            imagePosX: it.imagePosX ?? 50,
            imagePosY: it.imagePosY ?? 50
          });
        }
      }

      const total = Math.max(0, grandSubtotal - grandDiscount);

      const orderRef = push(ref(db, `customerOrders/${state.user.uid}`));
      const orderNumber = String(orderRef.key).slice(-6).toUpperCase();
      const payload = {
        orderNumber,
        createdAt: Date.now(),
        subtotal: grandSubtotal,
        discount: grandDiscount,
        total,
        note: ($("#note").value || "").trim(),
        items,
        storeBreakdown
      };

      $("#btnCheckout").disabled = true;
      $("#btnCheckout").textContent = "Placing…";

      await update(ref(db, `customerOrders/${state.user.uid}/${orderRef.key}`), payload);

      toast("good","Order placed", `Order #${orderNumber}`);
      // clear cart
      state.cart.clear();
      state.appliedCoupons = {};
      $("#note").value = "";
      renderCart();
      closeDrawer();

      // refresh orders view
      await loadOrders();
      location.hash = "#orders";
    }catch(e){
      showShopAlert("Failed to place order. Check Firebase rules.");
      toast("bad","Checkout failed", e.message || String(e));
    }finally{
      $("#btnCheckout").disabled = false;
      $("#btnCheckout").textContent = "Place Order";
    }
  });

  // ========= App bootstrap =========
  $("#btnReloadHome").addEventListener("click", loadHome);

  onAuthStateChanged(auth, async (user)=>{
    state.user = user || null;

    if(user){
      $("#userEmail").textContent = user.email || "(no email)";
      $("#userAvatar").textContent = (user.email || "U").slice(0,1).toUpperCase();
      setAppVisible(true);
      await loadHome();
      await loadOrders();
      route();
      renderCart();
      toast("good","Welcome", "Loaded stores & deals.");
    }else{
      setAppVisible(false);
    }
  });

  // Extra: reload home on demand
  $("#btnReloadHome").addEventListener("click", async ()=> {
    try{ await loadHome(); toast("good","Reloaded","Home updated."); }
    catch(e){ toast("bad","Load failed", e.message || String(e)); }
  });

</script>
</body>
</html>
