<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trolley — Owner Console</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#F7F7F8;
      --panel:#FFFFFF;
      --panel2:#FAFAFB;
      --text:#0B0B0C;
      --muted:#6B7280;
      --line:#E5E7EB;

      --accent:#0B0B0C;
      --good:#16A34A;
      --warn:#F59E0B;
      --bad:#EF4444;

      --radius:16px;
      --shadow: 0 18px 50px rgba(0,0,0,.10);
      --shadow2: 0 10px 22px rgba(0,0,0,.07);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1100px 700px at 18% 0%, rgba(0,0,0,.05), transparent 60%),
        radial-gradient(1100px 700px at 82% 10%, rgba(0,0,0,.035), transparent 60%),
        var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }
    a{color:inherit;text-decoration:none}
    .hidden{display:none !important;}

    .btn{
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
      user-select:none;
    }
    .btn:hover{border-color:#D1D5DB; box-shadow:0 10px 18px rgba(0,0,0,.06)}
    .btn:active{transform:scale(.99)}
    .btn.primary{
      background:var(--accent);
      color:#fff;
      border-color:transparent;
      font-weight:900;
      box-shadow:0 14px 26px rgba(0,0,0,.18);
    }
    .btn.danger{border-color:rgba(239,68,68,.35); color:#B91C1C}
    .btn.full{width:100%}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      outline:none;
      background:#fff;
      color:var(--text);
    }
    textarea{min-height:90px;resize:vertical}
    input:focus,select:focus,textarea:focus{
      border-color:rgba(17,24,39,.35);
      box-shadow:0 0 0 4px rgba(17,24,39,.08);
    }
    label{font-size:12px;color:var(--muted)}
    .hint{font-size:12px;color:var(--muted);line-height:1.5}

    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow2);
    }
    .card.pad{padding:16px}
    .muted{color:var(--muted)}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
      color:var(--muted);
      font-size:12px;
    }
    .badge{
      min-width:22px;height:22px;
      border-radius:999px;
      padding:0 8px;
      display:inline-flex;align-items:center;justify-content:center;
      background:#111827;
      border:1px solid #111827;
      color:#fff;
      font-size:12px;
      font-weight:800;
    }

    /* Toast */
    .toast{position:fixed;right:18px;bottom:18px;width:min(420px,calc(100vw - 36px));display:grid;gap:10px;z-index:999}
    .t{
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      box-shadow:var(--shadow);
      display:flex;gap:10px;align-items:flex-start;
      transition:.35s;
    }
    .dot{width:10px;height:10px;border-radius:999px;margin-top:4px;background:#111827}
    .dot.good{background:var(--good)}
    .dot.bad{background:var(--bad)}
    .dot.warn{background:var(--warn)}
    .t .title{font-weight:900}
    .t .msg{font-size:12px;color:var(--muted);margin-top:2px;white-space:pre-wrap}

    /* AUTH */
    #authView{min-height:100vh;display:grid;place-items:center;padding:18px;}
    .auth-shell{
      width:min(980px,96vw);
      display:grid;
      grid-template-columns:420px 1fr;
      overflow:hidden;
      border-radius:22px;
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      background:#fff;
    }
    .auth-left{padding:18px;border-right:1px solid var(--line)}
    .auth-right{
      padding:18px;
      background:
        radial-gradient(700px 450px at 20% 10%, rgba(0,0,0,.06), transparent 60%),
        radial-gradient(700px 450px at 85% 10%, rgba(0,0,0,.04), transparent 60%),
        #FBFBFC;
    }
    .logo{
      width:34px;height:34px;border-radius:12px;
      background:linear-gradient(135deg, rgba(0,0,0,.95), rgba(0,0,0,.45));
    }
    .tabs{display:flex;gap:10px;margin-top:14px}
    .tab{
      flex:1;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      cursor:pointer;
      font-weight:900;
    }
    .tab.active{color:var(--text);border-color:rgba(0,0,0,.25);background:rgba(0,0,0,.04)}
    .pane{display:none;gap:10px;margin-top:12px}
    .pane.active{display:grid}
    .alert{
      display:none;margin-top:12px;padding:10px;border-radius:12px;
      border:1px solid rgba(239,68,68,.35);
      background:rgba(239,68,68,.07);
      color:#7F1D1D;white-space:pre-wrap;
    }

    /* APP */
    .app{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
    .sidebar{
      position:sticky;top:0;height:100vh;padding:14px;
      border-right:1px solid var(--line);
      background:rgba(255,255,255,.85);
      backdrop-filter: blur(10px);
    }
    .side-top{
      display:flex;gap:10px;align-items:center;
      padding:10px;border-radius:16px;
      background:#fff;border:1px solid var(--line);
      box-shadow:var(--shadow2);
    }
    .brandMark{
      width:38px;height:38px;border-radius:12px;
      border:1px solid var(--line);
      background:#F3F4F6;
      display:grid;place-items:center;overflow:hidden;flex:0 0 auto;
    }
    .brandMark img{width:100%;height:100%;object-fit:cover;display:block}

    .nav{margin-top:14px;display:grid;gap:6px}
    .nav a{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:12px;
      color:var(--muted);border:1px solid transparent;font-weight:800;
    }
    .nav a.active{background:rgba(0,0,0,.05);border-color:rgba(0,0,0,.10);color:var(--text);font-weight:900}
    .dotNav{width:10px;height:10px;border-radius:999px;border:1px solid rgba(0,0,0,.25);background:#fff}
    .nav a.active .dotNav{background:#111827;border-color:#111827}

    .side-bottom{position:absolute;left:14px;right:14px;bottom:14px;display:grid;gap:10px}

    .main{padding:18px}
    .topbar{display:flex;justify-content:space-between;gap:12px;align-items:center;margin-bottom:16px}
    .topbar h1{margin:0;font-size:22px;font-weight:900}

    .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    .stat .label{font-size:12px;color:var(--muted)}
    .stat .value{font-size:22px;font-weight:900;margin-top:6px}
    .stat .sub{font-size:12px;color:var(--muted);margin-top:6px}

    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 10px;border-bottom:1px solid var(--line);text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:900;font-size:12px;letter-spacing:.03em;text-transform:uppercase}
    tr:hover td{background:rgba(0,0,0,.02)}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .spacer{height:12px}

    .imgPrev{
      width:100%;border:1px solid var(--line);border-radius:14px;overflow:hidden;
      background:#F3F4F6;aspect-ratio:16/9;display:grid;place-items:center;color:var(--muted)
    }
    .imgPrev img{width:100%;height:100%;object-fit:cover;display:block}

    @media (max-width: 860px){
      .app{grid-template-columns:1fr}
      .sidebar{position:relative;height:auto}
      .side-bottom{position:relative;left:auto;right:auto;bottom:auto}
      .auth-shell{grid-template-columns:1fr}
      .auth-left{border-right:none;border-bottom:1px solid var(--line)}
      .grid2{grid-template-columns:1fr}
      .kpi{grid-template-columns:1fr 1fr}
    }
    @media (max-width: 560px){
      .kpi{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <div id="toasts" class="toast"></div>

  <!-- AUTH -->
  <section id="authView">
    <div class="auth-shell">
      <div class="auth-left">
        <div style="display:flex;gap:10px;align-items:center;">
          <div class="logo"></div>
          <div>
            <div style="font-weight:900;">Trolley</div>
            <div class="muted" style="font-size:12px;">Owner Console</div>
          </div>
        </div>

        <div class="tabs">
          <button class="tab active" data-tab="login">Log in</button>
          <button class="tab" data-tab="signup">Sign up</button>
        </div>

        <div id="paneLogin" class="pane active">
          <label>Email</label>
          <input id="loginEmail" type="email" placeholder="owner@email.com" />
          <label>Password</label>
          <input id="loginPass" type="password" placeholder="••••••••" />
          <button id="btnLogin" class="btn primary full">Log in</button>
          <button id="btnForgot" class="btn full">Forgot password</button>
        </div>

        <div id="paneSignup" class="pane">
          <label>Email</label>
          <input id="signupEmail" type="email" placeholder="owner@email.com" />
          <label>Password</label>
          <input id="signupPass" type="password" placeholder="Min 6 chars" />
          <button id="btnSignup" class="btn primary full">Create account</button>
          <div class="hint">Enable Firebase Auth → Email/Password</div>
        </div>

        <div id="authAlert" class="alert"></div>
      </div>

      <div class="auth-right">
        <div class="card pad">
          <div class="pill"><span class="badge">Owner</span> Dashboard</div>
          <h2 style="margin:12px 0 6px 0;font-weight:900;">White theme, black accents.</h2>
          <p class="muted" style="margin:0;line-height:1.6;">Create stores and manage products with images.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- APP -->
  <section id="appView" class="hidden">
    <div class="app">
      <aside class="sidebar">
        <div class="side-top">
          <div class="brandMark" id="brandMark"><span class="muted" style="font-weight:900;">T</span></div>
          <div style="min-width:0">
            <div style="font-weight:900;">Owner Console</div>
            <div class="muted" id="storeChip" style="font-size:12px;">No store selected</div>
          </div>
        </div>

        <div class="spacer"></div>

        <div class="card pad">
          <div class="muted" style="font-size:12px;">Signed in as</div>
          <div id="userEmail" style="font-weight:800;margin-top:6px;overflow:hidden;text-overflow:ellipsis;">—</div>
          <div class="spacer"></div>
          <label>Your stores</label>
          <select id="storeSelect"></select>
          <div class="spacer"></div>
          <button id="btnNewStore" class="btn full">+ Create new store</button>
        </div>

        <nav class="nav" id="nav">
          <a href="#overview" data-page="overview" class="active"><span class="dotNav"></span> Overview</a>
          <a href="#products" data-page="products"><span class="dotNav"></span> Products</a>
          <a href="#settings" data-page="settings"><span class="dotNav"></span> Settings</a>
        </nav>

        <div class="side-bottom">
          <button id="btnSignOut" class="btn danger">Logout</button>
        </div>
      </aside>

      <main class="main">
        <div class="topbar">
          <div>
            <h1 id="pageTitle">Overview</h1>
            <div class="muted" id="pageSubtitle">Analytics and recent orders.</div>
          </div>
          <div class="row">
            <div class="pill">Mode: <b>Owner</b></div>
          </div>
        </div>

        <section data-view="overview">
          <div class="kpi">
            <div class="card pad stat">
              <div class="label">Total Revenue</div>
              <div class="value" id="kpiRevenue">$0.00</div>
              <div class="sub">From all orders.</div>
            </div>
            <div class="card pad stat">
              <div class="label">Total Orders</div>
              <div class="value" id="kpiOrders">0</div>
              <div class="sub">Placed orders.</div>
            </div>
            <div class="card pad stat">
              <div class="label">Active Products</div>
              <div class="value" id="kpiProducts">0</div>
              <div class="sub">Visible in store.</div>
            </div>
            <div class="card pad stat">
              <div class="label">Top Seller</div>
              <div class="value" id="kpiTop">—</div>
              <div class="sub">Most sold item.</div>
            </div>
          </div>

          <div class="spacer"></div>

          <div class="card pad">
            <div style="font-weight:900;">Recent Orders</div>
            <div class="muted" style="font-size:12px;margin-top:4px;">(Will appear when customer app starts placing orders.)</div>
          </div>
        </section>

        <section data-view="products" class="hidden">
          <div class="grid2">
            <div class="card pad">
              <div style="font-weight:900;">Add Product</div>
              <div class="hint">Upload image (recommended) or paste a direct image URL.</div>

              <div class="spacer"></div>

              <label>Name</label>
              <input id="prodName" placeholder="Milk" />

              <div class="spacer"></div>

              <div class="grid2">
                <div>
                  <label>Category</label>
                  <input id="prodCategory" placeholder="Dairy" />
                </div>
                <div>
                  <label>Stock</label>
                  <input id="prodStock" type="number" min="0" placeholder="20" />
                </div>
              </div>

              <div class="spacer"></div>

              <label>Price</label>
              <input id="prodPrice" type="number" min="0" step="0.01" placeholder="5.50" />

              <div class="spacer"></div>

              <label>Image URL (optional)</label>
              <input id="prodImageUrl" placeholder="https://.../image.png" />

              <div class="spacer"></div>

              <label>Or upload image file</label>
              <input id="prodImageFile" type="file" accept="image/*" />

              <div class="spacer"></div>

              <button id="btnSaveProduct" class="btn primary full">Save Product</button>
            </div>

            <div class="card pad">
              <div style="font-weight:900;">Preview</div>
              <div class="spacer"></div>
              <div class="imgPrev" id="prodPreview">No image</div>
              <div class="spacer"></div>
              <div class="pill">Name: <b id="pvName">—</b></div>
              <div class="spacer"></div>
              <div class="pill">Price: <b id="pvPrice">—</b></div>
            </div>
          </div>
        </section>

        <section data-view="settings" class="hidden">
          <div class="card pad">
            <div style="font-weight:900;">Store Settings</div>
            <div class="spacer"></div>

            <label>Logo URL (or upload file below)</label>
            <input id="logoUrl" placeholder="https://.../logo.png" />

            <div class="spacer"></div>

            <label>Upload Logo File</label>
            <input id="logoFile" type="file" accept="image/*" />

            <div class="spacer"></div>

            <div class="imgPrev" id="logoPreview">No logo</div>

            <div class="spacer"></div>

            <button id="btnSaveLogo" class="btn primary">Save Logo</button>
          </div>
        </section>
      </main>
    </div>
  </section>

<script type="module">
  // Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    sendPasswordResetEmail,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getDatabase, ref, get, update, push } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
  import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

  // Config (your project)
  const firebaseConfig = {
    apiKey: "AIzaSyCDQod1xzLOqAFgRDN50ohwLGWBtBwFVLc",
    authDomain: "trolley-89d31.firebaseapp.com",
    databaseURL: "https://trolley-89d31-default-rtdb.firebaseio.com",
    projectId: "trolley-89d31",
    storageBucket: "trolley-89d31.firebasestorage.app",
    messagingSenderId: "129434473018",
    appId: "1:129434473018:web:ae6b35d2d55526a7cedb03",
    measurementId: "G-81TRQL41K5"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const storage = getStorage(app);

  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));
  const money = (n)=>`$${Number(n||0).toFixed(2)}`;

  function toast(type, title, msg){
    const wrap = $("#toasts");
    const el = document.createElement("div");
    el.className = "t";
    const dot = type==="good"?"good":type==="bad"?"bad":"warn";
    el.innerHTML = `
      <div class="dot ${dot}"></div>
      <div>
        <div class="title">${escapeHtml(title)}</div>
        <div class="msg">${escapeHtml(msg||"")}</div>
      </div>
    `;
    wrap.appendChild(el);
    setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(8px)"; }, 3200);
    setTimeout(()=>{ el.remove(); }, 3800);
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function setAppVisible(isLoggedIn){
    $("#authView").classList.toggle("hidden", isLoggedIn);
    $("#appView").classList.toggle("hidden", !isLoggedIn);
    document.body.style.overflowY = isLoggedIn ? "auto" : "hidden";
  }

  // Tabs
  $$(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      $$(".tab").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const which = btn.dataset.tab;
      $("#paneLogin").classList.toggle("active", which==="login");
      $("#paneSignup").classList.toggle("active", which==="signup");
      $("#authAlert").style.display="none";
    });
  });

  // Auth actions
  $("#btnLogin").addEventListener("click", async ()=>{
    const email = $("#loginEmail").value.trim();
    const pass  = $("#loginPass").value;
    if(!email || !pass) return showAuthAlert("Enter email and password.");
    try{
      await signInWithEmailAndPassword(auth, email, pass);
      toast("good","Welcome","Logged in.");
    }catch(e){
      showAuthAlert(e.message);
    }
  });

  $("#btnSignup").addEventListener("click", async ()=>{
    const email = $("#signupEmail").value.trim();
    const pass  = $("#signupPass").value;
    if(!email || !pass) return showAuthAlert("Enter email and password.");
    try{
      await createUserWithEmailAndPassword(auth, email, pass);
      toast("good","Account created","Now create your store.");
    }catch(e){
      showAuthAlert(e.message);
    }
  });

  $("#btnForgot").addEventListener("click", async ()=>{
    const email = $("#loginEmail").value.trim();
    if(!email) return showAuthAlert("Enter your email first.");
    try{
      await sendPasswordResetEmail(auth, email);
      showAuthAlert("Reset email sent.");
    }catch(e){
      showAuthAlert(e.message);
    }
  });

  $("#btnSignOut").addEventListener("click", async ()=>{
    await signOut(auth);
    toast("warn","Signed out","You are logged out.");
  });

  function showAuthAlert(m){
    const a = $("#authAlert");
    a.style.display="block";
    a.textContent = m;
  }

  // Routing
  const pageMeta = {
    overview: { title:"Overview", subtitle:"Analytics and recent orders." },
    products: { title:"Products", subtitle:"Add products to your store." },
    settings: { title:"Settings", subtitle:"Store logo and branding." }
  };
  function showPage(page){
    $$("#nav a").forEach(a=>a.classList.toggle("active", a.dataset.page === page));
    $$("section[data-view]").forEach(s=>s.classList.toggle("hidden", s.dataset.view !== page));
    const m = pageMeta[page] || pageMeta.overview;
    $("#pageTitle").textContent = m.title;
    $("#pageSubtitle").textContent = m.subtitle;
  }
  function currentHashPage(){
    const p = (location.hash || "#overview").replace("#","");
    return pageMeta[p] ? p : "overview";
  }
  window.addEventListener("hashchange", ()=> showPage(currentHashPage()));

  // State
  let currentUser = null;
  let currentStoreId = null;

  // Store load (minimal for now)
  async function loadMyStores(){
    const snap = await get(ref(db, `ownerStores/${currentUser.uid}`));
    const storeIds = snap.exists() ? Object.keys(snap.val()||{}) : [];
    const sel = $("#storeSelect");

    if(storeIds.length === 0){
      sel.innerHTML = `<option value="">No stores yet</option>`;
      currentStoreId = null;
      $("#storeChip").textContent = "No store selected";
      return;
    }

    // pick first store only for now (simple)
    currentStoreId = storeIds[0];
    sel.innerHTML = `<option value="${currentStoreId}">${currentStoreId}</option>`;
    $("#storeChip").textContent = `Store: ${currentStoreId}`;
  }

  $("#btnNewStore").addEventListener("click", async ()=>{
    try{
      const name = prompt("Store name?")?.trim();
      if(!name) return;

      const storeKey = push(ref(db, "stores")).key;
      const now = Date.now();

      const updates = {};
      updates[`stores/${storeKey}/meta`] = { name, createdAt: now, logoUrl:"" };
      updates[`ownerStores/${currentUser.uid}/${storeKey}`] = true;

      await update(ref(db), updates);

      toast("good","Store created", name);
      await loadMyStores();
    }catch(e){
      toast("bad","Create store failed", e.message || String(e));
    }
  });

  // Product preview
  let localPreview = null;
  function setPreview(src){
    const box = $("#prodPreview");
    if(!src){ box.textContent="No image"; return; }
    box.innerHTML = `<img src="${src}" alt="preview">`;
  }

  function updatePreview(){
    $("#pvName").textContent = $("#prodName").value.trim() || "—";
    $("#pvPrice").textContent = $("#prodPrice").value ? money(Number($("#prodPrice").value)) : "—";
    const url = $("#prodImageUrl").value.trim();
    if(localPreview) return setPreview(localPreview);
    setPreview(url);
  }
  ["prodName","prodPrice","prodImageUrl"].forEach(id=> $("#"+id).addEventListener("input", updatePreview));

  $("#prodImageFile").addEventListener("change", ()=>{
    if(localPreview){ URL.revokeObjectURL(localPreview); localPreview=null; }
    const f = $("#prodImageFile").files?.[0];
    if(f) localPreview = URL.createObjectURL(f);
    updatePreview();
  });

  // Save product (writes to RTDB + uploads to Storage if file selected)
  $("#btnSaveProduct").addEventListener("click", async ()=>{
    try{
      if(!currentStoreId) return toast("warn","No store","Create a store first.");

      const name = $("#prodName").value.trim();
      const category = $("#prodCategory").value.trim();
      const stock = Number($("#prodStock").value);
      const price = Number($("#prodPrice").value);
      const urlInput = $("#prodImageUrl").value.trim();
      const file = $("#prodImageFile").files?.[0] || null;

      if(!name || !category) return toast("bad","Missing fields","Name + category required.");
      if(!Number.isFinite(stock) || stock < 0) return toast("bad","Invalid stock","Must be 0 or more.");
      if(!Number.isFinite(price) || price < 0) return toast("bad","Invalid price","Must be 0 or more.");

      const btn = $("#btnSaveProduct");
      btn.disabled = true;
      btn.textContent = "Working...";

      const id = push(ref(db, `stores/${currentStoreId}/products`)).key;
      let imageUrl = urlInput || "";

      if(file){
        const safeName = file.name.replace(/[^\w.\-]+/g,"_");
        const path = `stores/${currentStoreId}/products/${id}/${safeName}`;
        const storageRef = sRef(storage, path);
        await uploadBytes(storageRef, file);
        imageUrl = await getDownloadURL(storageRef);
      }

      await update(ref(db, `stores/${currentStoreId}/products/${id}`), {
        name, category, stock, price, imageUrl,
        createdAt: Date.now(),
        active: true
      });

      toast("good","Saved","Product saved to Firebase.");
      $("#prodName").value = "";
      $("#prodCategory").value = "";
      $("#prodStock").value = "";
      $("#prodPrice").value = "";
      $("#prodImageUrl").value = "";
      $("#prodImageFile").value = "";
      if(localPreview){ URL.revokeObjectURL(localPreview); localPreview=null; }
      updatePreview();
    }catch(e){
      toast("bad","Save failed", e.message || String(e));
    }finally{
      const btn = $("#btnSaveProduct");
      btn.disabled = false;
      btn.textContent = "Save Product";
    }
  });

  // Logo save
  function setBrandMark(url){
    const box = $("#brandMark");
    if(url) box.innerHTML = `<img src="${url}" alt="logo">`;
    else box.innerHTML = `<span class="muted" style="font-weight:900;">T</span>`;
  }
  function setLogoPreview(url){
    const box = $("#logoPreview");
    if(url) box.innerHTML = `<img src="${url}" alt="logo preview">`;
    else box.textContent="No logo";
  }

  let logoLocal = null;
  $("#logoUrl").addEventListener("input", ()=> setLogoPreview($("#logoUrl").value.trim()));
  $("#logoFile").addEventListener("change", ()=>{
    if(logoLocal){ URL.revokeObjectURL(logoLocal); logoLocal=null; }
    const f = $("#logoFile").files?.[0];
    if(f) logoLocal = URL.createObjectURL(f);
    setLogoPreview(logoLocal);
  });

  $("#btnSaveLogo").addEventListener("click", async ()=>{
    try{
      if(!currentStoreId) return toast("warn","No store","Create a store first.");

      const btn = $("#btnSaveLogo");
      btn.disabled = true;
      btn.textContent = "Working...";

      const urlInput = $("#logoUrl").value.trim();
      const file = $("#logoFile").files?.[0] || null;

      let logoUrl = urlInput || "";

      if(file){
        const safeName = file.name.replace(/[^\w.\-]+/g,"_");
        const path = `stores/${currentStoreId}/branding/logo_${Date.now()}_${safeName}`;
        const storageRef = sRef(storage, path);
        await uploadBytes(storageRef, file);
        logoUrl = await getDownloadURL(storageRef);
      }

      await update(ref(db, `stores/${currentStoreId}/meta`), { logoUrl, updatedAt: Date.now() });
      setBrandMark(logoUrl);
      setLogoPreview(logoUrl);
      toast("good","Saved","Logo saved.");
    }catch(e){
      toast("bad","Logo failed", e.message || String(e));
    }finally{
      const btn = $("#btnSaveLogo");
      btn.disabled = false;
      btn.textContent = "Save Logo";
    }
  });

  // Auth state
  onAuthStateChanged(auth, async (user)=>{
    currentUser = user || null;

    if(user){
      $("#userEmail").textContent = user.email || "(no email)";
      setAppVisible(true);
      showPage(currentHashPage());
      try{
        await loadMyStores();
        toast("good","Ready","You can navigate now.");
      }catch(e){
        toast("bad","Load failed", e.message || String(e));
      }
    }else{
      setAppVisible(false);
    }
  });
</script>
</body>
</html>
