<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trolley Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#F6F8FC;
      --panel:#FFFFFF;
      --text:#0F172A;
      --muted:#64748B;
      --line:#E6EAF2;

      --brand:#2563EB;
      --brand2:#06B6D4;
      --good:#16A34A;
      --warn:#F59E0B;
      --bad:#EF4444;

      --radius:16px;
      --shadow: 0 18px 40px rgba(15, 23, 42, .08);
      --shadow2: 0 10px 22px rgba(15, 23, 42, .06);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1000px 600px at 20% 0%, rgba(37,99,235,.10), transparent 55%),
                  radial-gradient(900px 600px at 85% 10%, rgba(6,182,212,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }

    a{color:inherit; text-decoration:none}

    /* IMPORTANT: when hidden, remove from layout completely */
    .hidden{display:none !important;}

    /* Buttons */
    .btn{
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition: transform .06s ease, box-shadow .2s ease, border-color .2s ease;
      box-shadow: 0 1px 0 rgba(15, 23, 42, .04);
      user-select:none;
    }
    .btn:hover{border-color:#D7DDEA; box-shadow: 0 10px 18px rgba(15, 23, 42, .06)}
    .btn:active{transform:scale(.99)}
    .btn.primary{
      border-color: transparent;
      color:#fff;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 14px 26px rgba(37,99,235,.20);
    }
    .btn.ghost{background: transparent}
    .btn.danger{
      background:#fff;
      border-color:#F1C7C7;
      color: var(--bad);
    }
    .btn.full{width:100%}

    /* Inputs */
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      outline:none;
      background:#fff;
      color:var(--text);
    }
    input:focus, select:focus{border-color: rgba(37,99,235,.45); box-shadow: 0 0 0 4px rgba(37,99,235,.08)}
    label{font-size:12px;color:var(--muted)}

    /* Cards */
    .card{
      background: var(--panel);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
    }
    .card.pad{padding:16px}
    .muted{color:var(--muted)}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      color:var(--muted);
      background:#fff;
      font-size:12px;
    }
    .badge{
      min-width:22px;height:22px;
      border-radius:999px;
      padding:0 8px;
      display:inline-flex;align-items:center;justify-content:center;
      background:#EEF2FF;
      border:1px solid #E0E7FF;
      color:#3730A3;
      font-size:12px;
      font-weight:600;
    }

    /* AUTH */
    #authView{
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:18px;
    }
    .auth-shell{
      width:min(980px, 96vw);
      display:grid;
      grid-template-columns: 420px 1fr;
      overflow:hidden;
      border-radius: 22px;
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      background:#fff;
    }
    .auth-left{padding:18px; border-right:1px solid var(--line)}
    .auth-right{padding:18px; background: linear-gradient(135deg, rgba(37,99,235,.06), rgba(6,182,212,.06))}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
    }
    .tabs{display:flex; gap:10px; margin-top:14px}
    .tab{
      flex:1;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      cursor:pointer;
      font-weight:600;
    }
    .tab.active{
      color: var(--text);
      border-color: rgba(37,99,235,.35);
      background: rgba(37,99,235,.06);
    }
    .pane{display:none; gap:10px; margin-top:12px}
    .pane.active{display:grid}
    .alert{
      display:none;
      margin-top:12px;
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.07);
      color:#7F1D1D;
      white-space:pre-wrap;
    }

    /* APP LAYOUT */
    #appView{
      min-height:100vh;
    }
    .app{
      display:grid;
      grid-template-columns: 260px 1fr;
      min-height:100vh;
    }
    .sidebar{
      position:sticky;
      top:0;
      height:100vh;
      padding:14px;
      border-right:1px solid var(--line);
      background: rgba(255,255,255,.70);
      backdrop-filter: blur(10px);
    }
    .side-top{
      display:flex;align-items:center;gap:10px;
      padding:10px;
      border-radius:16px;
      background:#fff;
      border:1px solid var(--line);
      box-shadow: var(--shadow2);
    }
    .side-top .title{font-weight:800}
    .side-top .sub{font-size:12px;color:var(--muted); margin-top:2px}

    .nav{
      margin-top:14px;
      display:grid;
      gap:6px;
    }
    .nav a{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;
      border-radius:12px;
      color: var(--muted);
      border:1px solid transparent;
    }
    .nav a.active{
      background: rgba(37,99,235,.08);
      border-color: rgba(37,99,235,.18);
      color: var(--text);
      font-weight:700;
    }
    .nav a:hover{background: rgba(15,23,42,.04)}
    .side-bottom{
      position:absolute;
      left:14px; right:14px; bottom:14px;
      display:grid;
      gap:10px;
    }

    .main{
      padding:18px;
    }
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      margin-bottom:16px;
    }
    .topbar h1{margin:0;font-size:22px}
    .top-actions{display:flex;gap:10px;align-items:center}

    .grid4{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:12px;
    }
    .stat .label{font-size:12px;color:var(--muted)}
    .stat .value{font-size:22px;font-weight:800;margin-top:6px}
    .stat .sub{font-size:12px;color:var(--muted);margin-top:6px}

    /* Tables */
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 10px; border-bottom:1px solid var(--line); text-align:left; font-size:13px}
    th{color:var(--muted); font-weight:700; font-size:12px; letter-spacing:.03em; text-transform:uppercase}
    tr:hover td{background: rgba(15,23,42,.02)}

    /* Products grid */
    .products-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:12px;
      margin-top:12px;
    }
    .p-item{padding:14px; overflow:hidden}
    .p-top{display:flex; align-items:flex-start; justify-content:space-between; gap:10px;}
    .p-name{font-weight:800}
    .p-meta{font-size:12px;color:var(--muted); margin-top:6px}
    .p-price{font-size:18px;font-weight:800;margin-top:10px}
    .p-actions{margin-top:12px; display:flex; gap:10px; align-items:center; justify-content:space-between}
    .stepper{display:flex; gap:6px; align-items:center}
    .stepper button{padding:10px 12px}
    .stepper input{width:70px; text-align:center}

    /* Product ‚Äúimage‚Äù */
    .thumb{
      height: 120px;
      border-radius: 14px;
      border:1px solid var(--line);
      margin-top:12px;
      background:
        radial-gradient(70px 70px at 25% 30%, rgba(37,99,235,.22), transparent 60%),
        radial-gradient(80px 80px at 75% 55%, rgba(6,182,212,.18), transparent 65%),
        linear-gradient(180deg, #FFFFFF, #F3F6FF);
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      padding:12px;
      position:relative;
      overflow:hidden;
    }
    .thumb:before{
      content:"";
      position:absolute;
      inset:-40px -40px auto auto;
      width:140px;height:140px;
      background: radial-gradient(circle, rgba(37,99,235,.18), transparent 60%);
      transform: rotate(10deg);
    }
    .thumb .emoji{
      position:relative;
      font-size: 28px;
    }
    .thumb .tag{
      position:relative;
      font-size: 12px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.85);
      color: var(--muted);
      font-weight:600;
    }

    /* Drawer (Cart) */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(15,23,42,.42);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease;
      z-index: 50;
    }
    .drawer{
      position:fixed;
      right:18px;
      top:18px;
      width: 420px;
      max-width: calc(100vw - 36px);
      height: calc(100vh - 36px);
      transform: translateX(110%);
      transition: transform .2s ease;
      z-index: 60;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .drawer-head{
      padding:14px;
      border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .drawer-body{padding:14px; overflow:auto; display:grid; gap:10px; flex:1}
    .drawer-foot{padding:14px; border-top:1px solid var(--line); display:grid; gap:10px}
    .cart-item{padding:12px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .cart-sub{font-size:12px;color:var(--muted); margin-top:4px}

    /* Responsive */
    @media (max-width: 1100px){
      .grid4{grid-template-columns: repeat(2, minmax(0,1fr))}
      .products-grid{grid-template-columns: repeat(2, minmax(0,1fr))}
    }
    @media (max-width: 860px){
      .app{grid-template-columns: 1fr}
      .sidebar{position:relative;height:auto}
      .side-bottom{position:relative;left:auto;right:auto;bottom:auto}
      .auth-shell{grid-template-columns: 1fr}
      .auth-left{border-right:none;border-bottom:1px solid var(--line)}
    }
    @media (max-width: 560px){
      .products-grid{grid-template-columns: 1fr}
      .grid4{grid-template-columns: 1fr}
    }
  </style>
</head>

<body>

  <!-- AUTH VIEW -->
  <section id="authView">
    <div class="auth-shell">
      <div class="auth-left">
        <div style="display:flex;gap:10px;align-items:center;">
          <div class="logo"></div>
          <div>
            <div style="font-weight:800;">Trolley</div>
            <div class="muted" style="font-size:12px;">Login to start shopping</div>
          </div>
        </div>

        <div class="tabs">
          <button class="tab active" data-tab="login">Log in</button>
          <button class="tab" data-tab="signup">Sign up</button>
        </div>

        <div id="paneLogin" class="pane active">
          <label>Email</label>
          <input id="loginEmail" type="email" placeholder="you@email.com" />
          <label>Password</label>
          <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          <button id="btnLogin" class="btn primary full">Log in</button>
          <button id="btnForgot" class="btn ghost full">Forgot password</button>
        </div>

        <div id="paneSignup" class="pane">
          <label>Email</label>
          <input id="signupEmail" type="email" placeholder="you@email.com" />
          <label>Password</label>
          <input id="signupPass" type="password" placeholder="Min 6 chars" />
          <button id="btnSignup" class="btn primary full">Create account</button>
          <div class="muted" style="font-size:12px;line-height:1.4;">
            Enable Firebase Authentication ‚Üí Email/Password.
          </div>
        </div>

        <div id="authAlert" class="alert"></div>
      </div>

      <div class="auth-right">
        <div class="card pad">
          <div class="pill"><span class="badge">New</span> Product cards now have images</div>
          <h2 style="margin:12px 0 6px 0;">Modern grocery dashboard</h2>
          <p class="muted" style="margin:0;line-height:1.6;">
            Sidebar navigation + pages + cart drawer. Single file only.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- APP VIEW -->
  <section id="appView" class="hidden">
    <div class="app">
      <aside class="sidebar">
        <div class="side-top">
          <div class="logo"></div>
          <div>
            <div class="title">Trolley</div>
            <div class="sub">Customer App</div>
          </div>
        </div>

        <nav class="nav" id="nav">
          <a href="#dashboard" data-page="dashboard" class="active">üè† Dashboard</a>
          <a href="#products"  data-page="products">üõí Products</a>
          <a href="#customers" data-page="customers">üë§ Customers</a>
          <a href="#orders"    data-page="orders">üßæ Orders</a>
          <a href="#delivery"  data-page="delivery">üöö Delivery</a>
          <a href="#settings"  data-page="settings">‚öôÔ∏è Settings</a>
        </nav>

        <div class="side-bottom">
          <div class="card pad">
            <div class="muted" style="font-size:12px;">Signed in as</div>
            <div id="userEmail" style="font-weight:700; margin-top:6px;">‚Äî</div>
          </div>
          <button id="btnSignOut" class="btn danger">Logout</button>
        </div>
      </aside>

      <main class="main">
        <div class="topbar">
          <div>
            <h1 id="pageTitle">Dashboard</h1>
            <div class="muted" id="pageSubtitle">Overview and recent activity.</div>
          </div>
          <div class="top-actions">
            <div class="pill">Branch: <b>All</b></div>
            <button id="btnCartOpen" class="btn primary">Cart <span id="cartCount" class="badge">0</span></button>
          </div>
        </div>

        <section data-view="dashboard">
          <div class="grid4">
            <div class="card pad stat">
              <div class="label">Sales Today</div>
              <div class="value" id="salesToday">$0.00</div>
              <div class="sub">Net of returns.</div>
            </div>
            <div class="card pad stat">
              <div class="label">Sales Orders Today</div>
              <div class="value" id="ordersToday">0</div>
              <div class="sub">Number of sales orders.</div>
            </div>
            <div class="card pad stat">
              <div class="label">Return Orders Today</div>
              <div class="value" id="returnsToday">0</div>
              <div class="sub">Number of returns.</div>
            </div>
            <div class="card pad stat">
              <div class="label">Active Branches</div>
              <div class="value">1</div>
              <div class="sub">Branches marked active.</div>
            </div>
          </div>

          <div style="margin-top:12px;" class="card pad">
            <div style="font-weight:800;">Recent Orders</div>
            <div class="muted" style="font-size:12px;margin-top:4px;">Last 10 orders.</div>
            <div style="margin-top:10px; overflow:auto;">
              <table>
                <thead>
                  <tr><th>ID</th><th>Date</th><th>Customer</th><th>Total</th></tr>
                </thead>
                <tbody id="recentOrdersBody">
                  <tr><td colspan="4" class="muted">No orders yet.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <section data-view="products" class="hidden">
          <div class="card pad">
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
              <input id="search" placeholder="Search by name / category / ID (e.g., Milk, Dairy, 101)" style="flex:1; min-width:240px;">
              <select id="category" style="width:220px;">
                <option value="">All categories</option>
              </select>
            </div>
          </div>

          <div class="products-grid" id="productsGrid"></div>
        </section>

        <section data-view="customers" class="hidden">
          <div class="card pad">
            <div style="font-weight:800;">Customers (demo)</div>
            <div style="margin-top:10px; overflow:auto;">
              <table>
                <thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Phone</th></tr></thead>
                <tbody id="customersBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section data-view="orders" class="hidden">
          <div class="card pad">
            <div style="font-weight:800;">Orders</div>
            <div style="margin-top:10px; overflow:auto;">
              <table>
                <thead><tr><th>Order ID</th><th>Date</th><th>Customer</th><th>Total</th></tr></thead>
                <tbody id="ordersBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section data-view="delivery" class="hidden">
          <div class="card pad">
            <div style="font-weight:800;">Delivery Queue</div>
            <div style="margin-top:10px;" id="deliveryList" class="muted">No pending deliveries.</div>

            <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
              <button id="btnCompleteDelivery" class="btn">Complete next delivery</button>
              <button id="btnClearDeliveries" class="btn danger">Clear all</button>
            </div>
          </div>
        </section>

        <section data-view="settings" class="hidden">
          <div class="card pad">
            <div style="font-weight:800;">Settings</div>
            <div class="muted" style="font-size:12px;margin-top:6px;">
              Export includes products, customers, orders, delivery queue (demo).
            </div>

            <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
              <button id="btnExportJSON" class="btn primary">Export Data JSON</button>
            </div>
          </div>
        </section>
      </main>

      <!-- CART DRAWER -->
      <div id="backdrop" class="backdrop"></div>
      <aside id="drawer" class="drawer card">
        <div class="drawer-head">
          <div>
            <div style="font-weight:800;">Cart</div>
            <div class="muted" style="font-size:12px;">Add/remove items then checkout</div>
          </div>
          <button id="btnCartClose" class="btn">Close</button>
        </div>

        <div id="cartBody" class="drawer-body">
          <div class="muted">Your cart is empty.</div>
        </div>

        <div class="drawer-foot">
          <div class="row">
            <div class="muted">Subtotal</div>
            <div style="font-weight:800;" id="subtotal">$0.00</div>
          </div>
          <div class="row">
            <div style="font-weight:800;">Total</div>
            <div style="font-weight:900;" id="total">$0.00</div>
          </div>

          <label>Customer ID (demo)</label>
          <input id="customerId" placeholder="e.g., 1001" />

          <button id="btnCheckout" class="btn primary full">Checkout</button>
          <button id="btnClearCart" class="btn danger full">Clear Cart</button>

          <div id="shopAlert" class="alert"></div>
        </div>
      </aside>

    </div>
  </section>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    sendPasswordResetEmail,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  // ======================================================
  // PASTE YOUR FIREBASE CONFIG HERE (Project settings -> Web)
  // ======================================================
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));
  const money = (n)=>`$${n.toFixed(2)}`;

  // Views
  const authView = $("#authView");
  const appView  = $("#appView");

  function setAppVisible(isLoggedIn){
    authView.classList.toggle("hidden", isLoggedIn);
    appView.classList.toggle("hidden", !isLoggedIn);
    // Prevent the "auth page peeks when scrolling"
    document.body.style.overflowY = isLoggedIn ? "auto" : "hidden";
  }

  // AUTH
  const authAlert = $("#authAlert");
  const showAuthAlert = (m)=>{ authAlert.style.display="block"; authAlert.textContent=m; };
  const clearAuthAlert= ()=>{ authAlert.style.display="none"; authAlert.textContent=""; };

  $$(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      $$(".tab").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const which = btn.dataset.tab;
      $("#paneLogin").classList.toggle("active", which==="login");
      $("#paneSignup").classList.toggle("active", which==="signup");
      clearAuthAlert();
    });
  });

  $("#btnLogin").addEventListener("click", async ()=>{
    clearAuthAlert();
    const email = $("#loginEmail").value.trim();
    const pass  = $("#loginPass").value;
    if(!email || !pass) return showAuthAlert("Enter email and password.");
    try{ await signInWithEmailAndPassword(auth, email, pass); }
    catch(e){ showAuthAlert(e.message); }
  });

  $("#btnSignup").addEventListener("click", async ()=>{
    clearAuthAlert();
    const email = $("#signupEmail").value.trim();
    const pass  = $("#signupPass").value;
    if(!email || !pass) return showAuthAlert("Enter email and password.");
    if(pass.length < 6) return showAuthAlert("Password must be at least 6 characters.");
    try{ await createUserWithEmailAndPassword(auth, email, pass); }
    catch(e){ showAuthAlert(e.message); }
  });

  $("#btnForgot").addEventListener("click", async ()=>{
    clearAuthAlert();
    const email = $("#loginEmail").value.trim();
    if(!email) return showAuthAlert("Type your email in the login field first.");
    try{ await sendPasswordResetEmail(auth, email); showAuthAlert("Password reset email sent."); }
    catch(e){ showAuthAlert(e.message); }
  });

  $("#btnSignOut").addEventListener("click", async ()=>{ await signOut(auth); });

  // Demo Data + category icons (for ‚Äúimages‚Äù)
  const catEmoji = {
    Dairy: "ü•õ",
    Bakery: "ü•ñ",
    Produce: "üçé",
    Snacks: "üç™",
    Drinks: "ü•§",
    Meat: "üçó",
    Frozen: "üßä",
    Default: "üõí"
  };

  const state = {
    products: [
      { ID:101, Name:"Milk",   Category:"Dairy",   Price:5.50, Stock:20 },
      { ID:102, Name:"Bread",  Category:"Bakery",  Price:3.00, Stock:30 },
      { ID:103, Name:"Eggs",   Category:"Dairy",   Price:7.00, Stock:50 },
      { ID:201, Name:"Apple",  Category:"Produce", Price:0.80, Stock:100 },
      { ID:202, Name:"Banana", Category:"Produce", Price:0.60, Stock:120 },
      { ID:301, Name:"Yogurt", Category:"Dairy",   Price:2.25, Stock:40 }
    ],
    customers: [
      { ID:1001, Name:"Demo Customer", Email:"demo@trolley.com", Phone:"+20..." },
      { ID:1002, Name:"Second Customer", Email:"second@trolley.com", Phone:"+20..." }
    ],
    cart: new Map(),
    orders: [],
    deliveryQueue: []
  };
  let orderCounter = 1000;

  // Sidebar routing
  const pageTitle = $("#pageTitle");
  const pageSubtitle = $("#pageSubtitle");

  const pageMeta = {
    dashboard: { title:"Dashboard", subtitle:"Overview and recent activity." },
    products:  { title:"Products",  subtitle:"Browse groceries and add to cart." },
    customers: { title:"Customers", subtitle:"Customer list (demo table)." },
    orders:    { title:"Orders",    subtitle:"Your order history." },
    delivery:  { title:"Delivery",  subtitle:"Queue of pending deliveries." },
    settings:  { title:"Settings",  subtitle:"Export JSON and project info." }
  };

  function showPage(page){
    $$("#nav a").forEach(a => a.classList.toggle("active", a.dataset.page === page));
    $$("section[data-view]").forEach(sec => sec.classList.toggle("hidden", sec.dataset.view !== page));
    const m = pageMeta[page] || pageMeta.dashboard;
    pageTitle.textContent = m.title;
    pageSubtitle.textContent = m.subtitle;
  }

  function currentHashPage(){
    const p = (location.hash || "#dashboard").replace("#","");
    return pageMeta[p] ? p : "dashboard";
  }
  window.addEventListener("hashchange", ()=> showPage(currentHashPage()));

  // Products rendering
  const productsGrid = $("#productsGrid");
  const search = $("#search");
  const category = $("#category");

  function renderCategories(){
    const cats = Array.from(new Set(state.products.map(p=>p.Category))).sort();
    category.innerHTML = `<option value="">All categories</option>` + cats.map(c=>`<option value="${c}">${c}</option>`).join("");
  }

  function renderProducts(){
    const q = (search.value || "").trim().toLowerCase();
    const cat = category.value;

    const filtered = state.products.filter(p=>{
      if(cat && p.Category !== cat) return false;
      if(!q) return true;
      return String(p.ID).includes(q) || p.Name.toLowerCase().includes(q) || p.Category.toLowerCase().includes(q);
    });

    productsGrid.innerHTML = filtered.map(p=>{
      const out = p.Stock <= 0;
      const emoji = catEmoji[p.Category] || catEmoji.Default;
      return `
        <div class="card p-item">
          <div class="p-top">
            <div>
              <div class="p-name">${p.Name}</div>
              <div class="p-meta">${p.Category} ‚Ä¢ ID ${p.ID} ‚Ä¢ Stock: ${p.Stock}</div>
              <div class="p-price">${money(p.Price)}</div>
            </div>
            <div class="pill">${out ? "Out of stock" : "In stock"}</div>
          </div>

          <div class="thumb">
            <div class="emoji">${emoji}</div>
            <div class="tag">${p.Category}</div>
          </div>

          <div class="p-actions">
            <div class="stepper">
              <button class="btn ghost" data-dec="${p.ID}">‚àí</button>
              <input data-qty="${p.ID}" value="1" />
              <button class="btn ghost" data-inc="${p.ID}">+</button>
            </div>
            <button class="btn primary" data-add="${p.ID}" ${out?"disabled":""}>Add</button>
          </div>
        </div>
      `;
    }).join("");

    productsGrid.querySelectorAll("[data-inc]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = Number(b.dataset.inc);
        const inp = productsGrid.querySelector(`[data-qty="${id}"]`);
        inp.value = String(Math.min(99, (Number(inp.value)||1)+1));
      });
    });
    productsGrid.querySelectorAll("[data-dec]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = Number(b.dataset.dec);
        const inp = productsGrid.querySelector(`[data-qty="${id}"]`);
        inp.value = String(Math.max(1, (Number(inp.value)||1)-1));
      });
    });
    productsGrid.querySelectorAll("[data-add]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = Number(b.dataset.add);
        const qty = Number(productsGrid.querySelector(`[data-qty="${id}"]`).value) || 1;
        addToCart(id, qty);
      });
    });
  }

  search?.addEventListener("input", renderProducts);
  category?.addEventListener("change", renderProducts);

  // Cart
  const backdrop = $("#backdrop");
  const drawer = $("#drawer");
  const cartBody = $("#cartBody");
  const cartCount = $("#cartCount");
  const subtotalEl = $("#subtotal");
  const totalEl = $("#total");
  const customerIdEl = $("#customerId");
  const shopAlert = $("#shopAlert");

  const showShopAlert = (m)=>{ shopAlert.style.display="block"; shopAlert.textContent=m; };
  const clearShopAlert= ()=>{ shopAlert.style.display="none"; shopAlert.textContent=""; };

  function openDrawer(){
    drawer.style.transform = "translateX(0)";
    backdrop.style.opacity = "1";
    backdrop.style.pointerEvents = "auto";
  }
  function closeDrawer(){
    drawer.style.transform = "translateX(110%)";
    backdrop.style.opacity = "0";
    backdrop.style.pointerEvents = "none";
  }

  $("#btnCartOpen").addEventListener("click", ()=>{ renderCart(); openDrawer(); });
  $("#btnCartClose").addEventListener("click", closeDrawer);
  backdrop.addEventListener("click", closeDrawer);

  function cartTotals(){
    let subtotal = 0, count = 0;
    for(const it of state.cart.values()){
      subtotal += it.Price * it.qty;
      count += it.qty;
    }
    return { subtotal, total: subtotal, count };
  }

  function renderCart(){
    const items = Array.from(state.cart.values());
    const { subtotal, total, count } = cartTotals();
    cartCount.textContent = String(count);

    if(items.length === 0){
      cartBody.innerHTML = `<div class="muted">Your cart is empty.</div>`;
    }else{
      cartBody.innerHTML = items.map(it=>{
        const line = it.Price * it.qty;
        return `
          <div class="card cart-item">
            <div class="row">
              <div>
                <div style="font-weight:800;">${it.Name}</div>
                <div class="cart-sub">${money(it.Price)} ‚Ä¢ ID ${it.ID}</div>
              </div>
              <div style="font-weight:900;">${money(line)}</div>
            </div>
            <div class="row" style="margin-top:10px;">
              <div class="pill">Qty: ${it.qty}</div>
              <div style="display:flex; gap:8px; margin-left:auto;">
                <button class="btn" data-minus="${it.ID}">‚àí</button>
                <button class="btn" data-plus="${it.ID}">+</button>
                <button class="btn danger" data-remove="${it.ID}">Remove</button>
              </div>
            </div>
          </div>
        `;
      }).join("");

      cartBody.querySelectorAll("[data-plus]").forEach(b=> b.addEventListener("click", ()=> addToCart(Number(b.dataset.plus), 1)));
      cartBody.querySelectorAll("[data-minus]").forEach(b=> b.addEventListener("click", ()=> removeQty(Number(b.dataset.minus), 1)));
      cartBody.querySelectorAll("[data-remove]").forEach(b=> b.addEventListener("click", ()=> removeItem(Number(b.dataset.remove))));
    }

    subtotalEl.textContent = money(subtotal);
    totalEl.textContent = money(total);
  }

  function addToCart(productID, qty){
    clearShopAlert();
    const p = state.products.find(x=>x.ID===productID);
    if(!p || qty<=0) return;
    if(p.Stock < qty) return showShopAlert(`Insufficient stock for ${p.Name}. Available: ${p.Stock}`);
    p.Stock -= qty;

    const it = state.cart.get(productID);
    if(it) it.qty += qty;
    else state.cart.set(productID, { ID:p.ID, Name:p.Name, Price:p.Price, qty });

    renderProducts();
    renderCart();
  }

  function removeQty(productID, qty){
    clearShopAlert();
    const p = state.products.find(x=>x.ID===productID);
    const it = state.cart.get(productID);
    if(!p || !it) return;

    const dec = Math.min(qty, it.qty);
    it.qty -= dec;
    p.Stock += dec;
    if(it.qty<=0) state.cart.delete(productID);

    renderProducts();
    renderCart();
  }

  function removeItem(productID){
    clearShopAlert();
    const p = state.products.find(x=>x.ID===productID);
    const it = state.cart.get(productID);
    if(!p || !it) return;

    p.Stock += it.qty;
    state.cart.delete(productID);

    renderProducts();
    renderCart();
  }

  function clearCart(){
    for(const it of state.cart.values()){
      const p = state.products.find(x=>x.ID===it.ID);
      if(p) p.Stock += it.qty;
    }
    state.cart.clear();
    renderProducts();
    renderCart();
  }

  $("#btnClearCart").addEventListener("click", clearCart);

  // Orders + Dashboard
  function renderOrdersTables(){
    const recentBody = $("#recentOrdersBody");
    const ordersBody = $("#ordersBody");

    if(state.orders.length === 0){
      recentBody.innerHTML = `<tr><td colspan="4" class="muted">No orders yet.</td></tr>`;
      ordersBody.innerHTML = `<tr><td colspan="4" class="muted">No orders yet.</td></tr>`;
    } else {
      const last10 = state.orders.slice(-10).reverse();
      recentBody.innerHTML = last10.map(o=>`
        <tr><td>${o.orderID}</td><td>${o.date}</td><td>${o.customerID}</td><td>${money(o.total)}</td></tr>
      `).join("");

      ordersBody.innerHTML = state.orders.slice().reverse().map(o=>`
        <tr><td>${o.orderID}</td><td>${o.date}</td><td>${o.customerID}</td><td>${money(o.total)}</td></tr>
      `).join("");
    }

    const totalSales = state.orders.reduce((s,o)=>s+o.total,0);
    $("#salesToday").textContent = money(totalSales);
    $("#ordersToday").textContent = String(state.orders.length);
  }

  function renderCustomers(){
    const body = $("#customersBody");
    body.innerHTML = state.customers.map(c=>`
      <tr><td>${c.ID}</td><td>${c.Name}</td><td>${c.Email}</td><td>${c.Phone}</td></tr>
    `).join("");
  }

  function renderDelivery(){
    const box = $("#deliveryList");
    if(state.deliveryQueue.length === 0){
      box.classList.add("muted");
      box.innerHTML = `No pending deliveries.`;
    } else {
      box.classList.remove("muted");
      box.innerHTML = state.deliveryQueue.map((d,i)=>`
        <div style="padding:8px 0; border-bottom:1px solid var(--line);">
          <b>${d.label}</b> <span class="muted">(position ${i+1})</span>
        </div>
      `).join("");
    }
  }

  $("#btnCompleteDelivery").addEventListener("click", ()=>{
    state.deliveryQueue.shift();
    renderDelivery();
  });

  $("#btnClearDeliveries").addEventListener("click", ()=>{
    state.deliveryQueue = [];
    renderDelivery();
  });

  // Checkout
  $("#btnCheckout").addEventListener("click", ()=>{
    clearShopAlert();
    if(state.cart.size === 0) return showShopAlert("Cart is empty.");
    const cid = customerIdEl.value.trim();
    if(!cid) return showShopAlert("Enter Customer ID (demo).");

    const lines = Array.from(state.cart.values()).map(it=>({
      productId: it.ID, name: it.Name, unitPrice: it.Price, qty: it.qty,
      lineTotal: it.Price * it.qty
    }));
    const total = lines.reduce((s,l)=>s+l.lineTotal,0);
    const orderID = ++orderCounter;
    const date = new Date().toISOString().slice(0,10);

    state.orders.push({ orderID, date, customerID: cid, total, lines });
    state.deliveryQueue.push({ orderID, label: `Order ${orderID}` });

    state.cart.clear();
    customerIdEl.value = "";

    renderCart();
    renderOrdersTables();
    renderDelivery();
    closeDrawer();
  });

  // Export JSON
  $("#btnExportJSON").addEventListener("click", ()=>{
    const payload = {
      version: "1.0",
      generatedAt: new Date().toISOString(),
      products: state.products,
      customers: state.customers,
      orders: state.orders,
      deliveryQueue: state.deliveryQueue
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "trolley_export.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
  });

  // Auth state
  onAuthStateChanged(auth, (user)=>{
    if(user){
      $("#userEmail").textContent = user.email || "(no email)";
      setAppVisible(true);
      renderCategories();
      renderProducts();
      renderCustomers();
      renderOrdersTables();
      renderDelivery();
      showPage(currentHashPage());
    }else{
      setAppVisible(false);
    }
  });
</script>
</body>
</html>
